<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPG Naruto</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-color: #fafafa;
            --sidebar-bg: #ffffff;
            --text-color: #262626;
            --primary-color: #ff5e00;
            --card-bg: #ffffff;
            --border-color: #dbdbdb;
            --green-color: #2ecc71;
            --yellow-color: #f1c40f;
            --danger-color: #ed4956;
            
            /* CORES DE STATUS */
            --stat-chakra: #7f8c8d; 
            --stat-stamina: #27ae60; 
            --stat-dano: #e74c3c;   
            --stat-buff: #3498db;   
        }
        body.dark-mode { --bg-color: #000000; --sidebar-bg: #000000; --text-color: #f5f5f5; --card-bg: #121212; --border-color: #363636; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-color); color: var(--text-color); height: 100vh; overflow: hidden; }

        /* LOGIN */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .login-box { background: white; padding: 30px; border-radius: 10px; width: 100%; max-width: 320px; text-align: center; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; }
        .login-box button { background: var(--primary-color); color: white; border: none; padding: 12px; width: 100%; cursor: pointer; border-radius: 5px; font-weight: bold; font-size: 16px; }

        /* LAYOUT */
        #app-container { display: flex; height: 100vh; position: relative; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 998; opacity: 0; transition: opacity 0.3s; }
        .sidebar-overlay.active { display: block; opacity: 1; }
        .sidebar { width: 250px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 20px; overflow-y: auto; flex-shrink: 0; z-index: 999; transition: transform 0.3s ease; }
        .logo { font-size: 24px; font-weight: bold; color: var(--primary-color); margin-bottom: 40px; font-family: 'Segoe UI', sans-serif; letter-spacing: 1px; }
        .sidebar button { background: none; border: none; color: var(--text-color); width: 100%; text-align: left; padding: 12px 15px; cursor: pointer; border-radius: 8px; transition: 0.2s; display: flex; align-items: center; gap: 15px; margin-bottom: 5px; font-size: 1rem; }
        .sidebar button:hover { background-color: rgba(0,0,0,0.05); }
        .sidebar button.active { background-color: rgba(255, 94, 0, 0.1); font-weight: bold; color: var(--primary-color); border-left: 4px solid var(--primary-color); }
        #btn-admin-panel { display: none; color: #ed4956; font-weight: bold; }

        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; width: 100%; }
        header { height: 60px; background: var(--sidebar-bg); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; flex-shrink: 0; z-index: 10; }
        #mobile-menu-btn { display: none; background: none; border: none; font-size: 1.5rem; color: var(--text-color); cursor: pointer; margin-right: 10px; }
        .top-nav { display: flex; gap: 15px; overflow-x: auto; flex: 1; margin-right: 10px; scrollbar-width: none; }
        .top-btn { background: none; border: none; padding: 10px 5px; color: #8e8e8e; cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; font-size: 0.9rem; font-weight: 500; }
        .top-btn.active { border-bottom-color: var(--primary-color); color: var(--text-color); font-weight: bold; }

        .user-area { display: flex; align-items: center; gap: 10px; position: relative; }
        .ryos { font-weight: bold; color: #e6b800; background: rgba(230, 184, 0, 0.1); padding: 5px 10px; border-radius: 15px; white-space: nowrap; font-size: 0.8rem; }
        .profile-circle { width: 35px; height: 35px; border-radius: 50%; overflow: hidden; cursor: pointer; border: 1px solid var(--border-color); flex-shrink: 0; }
        .profile-circle img { width: 100%; height: 100%; object-fit: cover; }
        .dropdown-menu { display: none; position: absolute; top: 50px; right: 0; background: var(--card-bg); border: 1px solid var(--border-color); width: 200px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 5px 0; z-index: 100; }
        .dropdown-menu.show { display: block; }
        .dropdown-item { display: block; padding: 12px 15px; color: var(--text-color); text-decoration: none; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 10px; }
        .dropdown-item:hover { background: rgba(0,0,0,0.03); }

        #content-area { padding: 20px; overflow-y: auto; background-color: var(--bg-color); flex: 1; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }

        /* CARDS E GRIDS */
        .bucket-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; margin-top: 20px; }
        .card { background: var(--card-bg); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); text-align: center; cursor: pointer; transition: 0.2s; overflow: hidden; position: relative; }
        .card:hover { transform: translateY(-2px); border-color: var(--primary-color); }
        .card-img-top { width: 100%; height: 120px; object-fit: cover; border-radius: 4px; margin-bottom: 8px; border: 1px solid #eee; }
        
        .buy-btn { background-color: var(--primary-color); color: white; border: none; padding: 10px; width: 100%; border-radius: 5px; font-weight: bold; margin-top: 8px; font-size: 1rem; cursor: pointer; }
        .buy-btn:hover { background-color: #e05200; }
        
        /* CONTROLES DE INVENTARIO (QTD E BOTAO MENOS) */
        .inventory-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 8px;
            background: rgba(0,0,0,0.03);
            padding: 5px;
            border-radius: 20px;
        }
        .qtd-badge {
            font-weight: bold;
            font-size: 0.9rem;
            color: var(--text-color);
        }
        .btn-minus {
            background: var(--danger-color);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .btn-minus:hover { transform: scale(1.1); }
        .btn-minus:active { transform: scale(0.9); }

        /* Maestria no Card */
        .maestria-display { display: block; font-size: 0.85rem; color: var(--yellow-color); font-weight: bold; margin-top: 4px; text-shadow: 0 0 1px rgba(0,0,0,0.1); }

        /* NOVO: FILTROS DA LOJA */
        .shop-header { margin-bottom: 20px; background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
        .shop-location-select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1rem; margin-bottom: 10px; background: var(--bg-color); color: var(--text-color); }
        .shop-categories { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .shop-cat-btn { padding: 8px 15px; border: 1px solid var(--border-color); background: var(--bg-color); border-radius: 20px; cursor: pointer; white-space: nowrap; font-weight: 500; color: var(--text-color); transition: 0.2s; }
        .shop-cat-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .shop-cat-btn:hover { opacity: 0.8; }

        /* MISSÕES */
        .mission-btn-start { background: var(--primary-color); color: white; border: none; padding: 10px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .mission-btn-collect { background: var(--green-color); color: white; border: none; padding: 10px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 5px; animation: pulse 1.5s infinite; }
        .mission-btn-wait { background: var(--yellow-color); color: #333; width: 100%; border: none; padding: 10px; border-radius: 5px; font-weight: bold; margin-top: 5px; cursor: not-allowed; }
        .mission-btn-done { background: #ccc; color: #666; width: 100%; border: none; padding: 10px; border-radius: 5px; font-weight: bold; margin-top: 5px; cursor: not-allowed; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* FEED */
        #feed { max-width: 600px; margin: 0 auto; width: 100%; }
        .create-post { background: var(--card-bg); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        .create-post textarea { width: 100%; padding: 10px; border: none; outline: none; background: transparent; color: var(--text-color); resize: none; font-size: 1rem; }
        .post-tools { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color); padding-top: 10px; margin-top: 10px; }
        .upload-btn { cursor: pointer; color: var(--primary-color); font-size: 0.9rem; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        #imageInput { display: none; }
        #preview-container { margin-top: 10px; display: none; position: relative; width: 100%; text-align: center; background: #000; border-radius: 4px; overflow: hidden; }
        #preview-image { max-width: 100%; max-height: 300px; object-fit: contain; }
        .remove-img { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-post { background: var(--primary-color); color: white; border: none; padding: 8px 20px; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        
        .post { background: var(--card-bg); border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border-color); position: relative; overflow: visible; }
        .post-header { display: flex; align-items: center; padding: 10px; }
        .user-avatar-post { width: 35px; height: 35px; border-radius: 50%; background: #efefef; margin-right: 10px; overflow: hidden; border: 1px solid var(--border-color); }
        .user-avatar-post img { width: 100%; height: 100%; object-fit: cover; }
        .post-info { display: flex; flex-direction: column; }
        .post-author { font-weight: 600; font-size: 0.95rem; color: var(--text-color); }
        .post-time { font-size: 0.75rem; color: #8e8e8e; }
        .post-menu-container { margin-left: auto; position: relative; }
        .post-options-btn { cursor: pointer; color: var(--text-color); padding: 8px; width: 30px; text-align: center; }
        .post-dropdown { display: none; position: absolute; top: 100%; right: 0; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; width: 140px; }
        .post-dropdown.active { display: block; }
        .post-dropdown-item { padding: 10px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: var(--text-color); }
        .post-dropdown-item.danger { color: var(--danger-color); }
        .post-content { padding: 0 10px 10px 10px; line-height: 1.5; white-space: pre-wrap; font-size: 0.95rem; }
        .post-image { width: 100%; height: auto; display: block; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); max-height: 600px; object-fit: cover; }
        .post-actions { display: flex; padding: 10px; gap: 15px; }
        .action-btn { background: none; border: none; cursor: pointer; color: var(--text-color); font-size: 1.5rem; display: flex; align-items: center; gap: 5px; padding: 0; }
        .action-btn.liked { color: var(--danger-color); }
        .edit-textarea { width: 100%; border: 1px solid var(--primary-color); border-radius: 4px; padding: 10px; margin: 10px 0; }

        /* RANKINGS */
        .rankings-wrapper { display: flex; gap: 20px; flex-wrap: wrap; padding-bottom: 20px; }
        .ranking-col { flex: 1 1 300px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; }
        .ranking-col h3 { color: var(--primary-color); text-align: center; margin-bottom: 15px; border-bottom: 2px solid var(--primary-color); font-size: 1.1rem; }
        .ranking-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .ranking-table td { padding: 8px; border-bottom: 1px solid var(--border-color); }

        /* MODAIS */
        .modal-overlay-comment { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .close-modal { position: absolute; top: 10px; left: 15px; font-size: 1.8rem; color: white; cursor: pointer; z-index: 20; text-shadow: 0 0 5px black; }
        .modal-content-card { background: var(--card-bg); padding: 30px; border-radius: 10px; width: 90%; max-width: 350px; text-align: center; position: relative; border: 1px solid var(--border-color); }
        .jutsu-modal-img { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .jutsu-modal-rank { display: inline-block; background: var(--primary-color); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; margin-bottom: 10px; }
        .jutsu-modal-price { color: var(--green-color); font-weight: bold; font-size: 1.2rem; border-top: 1px solid var(--border-color); padding-top: 15px; }
        
        .jutsu-stats-row { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
        .jutsu-stat-tag { padding: 4px 12px; border-radius: 15px; color: white; font-weight: bold; font-size: 0.8rem; }
        .tag-dano { background-color: var(--stat-dano); }
        .tag-chakra { background-color: var(--stat-chakra); }
        .tag-stamina { background-color: var(--stat-stamina); }
        .tag-buff { background-color: var(--stat-buff); }

        .modal-content-profile { background: var(--card-bg); width: 90%; max-width: 800px; max-height: 90vh; border-radius: 15px; overflow-y: auto; position: relative; border: 1px solid var(--border-color); }
        .profile-header { background: linear-gradient(to right, #ff5e00, #ff9100); padding: 40px 20px; text-align: center; color: white; }
        .profile-avatar-large { width: 100px; height: 100px; border-radius: 50%; border: 4px solid white; margin: 0 auto 15px auto; overflow: hidden; background: #fff; }
        .profile-avatar-large img { width: 100%; height: 100%; object-fit: cover; }
        .profile-name { font-size: 1.8rem; font-weight: bold; }
        .profile-char { font-size: 1.1rem; opacity: 0.9; }
        .profile-body { padding: 20px; }
        .profile-stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; margin-bottom: 30px; }
        .stat-card { background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 10px; padding: 10px; text-align: center; }
        .stat-value { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); }
        .stat-label { font-size: 0.75rem; color: #777; margin-top: 3px; text-transform: uppercase; font-weight: bold; }
        .stats-divider { grid-column: 1 / -1; font-weight: bold; color: var(--text-color); margin: 20px 0 5px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }

        .modal-content-comment { background: var(--card-bg); width: 90%; max-width: 900px; height: 80vh; border-radius: 4px; display: flex; overflow: hidden; position: relative; }
        .modal-left { flex: 1.5; background: #000; display: flex; align-items: center; justify-content: center; }
        .modal-left img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .modal-right { flex: 1; display: flex; flex-direction: column; background: var(--card-bg); border-left: 1px solid var(--border-color); }
        .comments-list { flex: 1; padding: 15px; overflow-y: auto; }
        .comment-input-area { padding: 15px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; }
        .comment-input-area input { flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 20px; outline: none; }
        .edit-input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 5px; }
        .edit-avatar-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); margin: 10px auto; display: block; }

        /* HISTORIA */
        .historia-container { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; max-width: 800px; margin: 0 auto; position: relative; }
        .historia-img-container { width: 100%; height: 300px; background-color: #000; position: relative; }
        .historia-img-container img { width: 100%; height: 100%; object-fit: cover; }
        .historia-divider { height: 4px; background-color: #dbdbdb; border: none; margin: 0; }
        .historia-text-content { padding: 30px; line-height: 1.8; font-size: 1.1rem; color: var(--text-color); white-space: pre-wrap; }
        .btn-edit-historia { position: absolute; bottom: 15px; right: 15px; background: var(--primary-color); color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-edit-historia:hover { background: #e05200; }

        /* FRASES */
        .frase-input-area { background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 20px; display: flex; gap: 10px; }
        .frase-input-area input { flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; outline: none; }
        .frases-list { display: flex; flex-direction: column; gap: 10px; }
        .frase-item { background: var(--card-bg); padding: 20px; border-bottom: 1px solid #ccc; cursor: pointer; transition: background 0.2s; position: relative; border-radius: 5px; display: flex; justify-content: space-between; align-items: flex-start; }
        .frase-item:hover { background-color: rgba(0,0,0,0.02); }
        .frase-content { font-size: 1.1rem; font-style: italic; color: var(--text-color); flex: 1; padding-right: 30px; }
        .frase-author { font-size: 0.85rem; color: var(--primary-color); font-weight: bold; margin-top: 5px; }
        
        .options-menu-container { margin-left: auto; position: relative; }
        .options-btn { cursor: pointer; color: var(--text-color); padding: 8px; width: 30px; text-align: center; }
        .options-dropdown { display: none; position: absolute; top: 100%; right: 0; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; width: 140px; }
        .options-dropdown.active { display: block; }
        .options-item { padding: 10px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: var(--text-color); }
        .options-item.danger { color: var(--danger-color); }

        /* BARRA DE XP */
        .level-container { background: var(--card-bg); padding: 15px; border-radius: 10px; border: 1px solid var(--border-color); margin-bottom: 20px; }
        .level-info { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; color: var(--text-color); }
        .xp-bar-bg { width: 100%; height: 20px; background: #eee; border-radius: 10px; overflow: hidden; position: relative; }
        .xp-bar-fill { height: 100%; background: linear-gradient(90deg, #ff9100, #ff5e00); width: 0%; transition: width 0.5s ease-in-out; }
        .xp-text { position: absolute; width: 100%; text-align: center; top: 0; left: 0; font-size: 0.75rem; color: #333; line-height: 20px; font-weight: bold; text-shadow: 0 0 2px white; }

        /* MOBILE */
        @media (max-width: 768px) {
            #mobile-menu-btn { display: block; }
            .sidebar { position: fixed; top: 0; left: -260px; height: 100%; box-shadow: 2px 0 10px rgba(0,0,0,0.3); transition: left 0.3s ease; }
            .sidebar.mobile-active { left: 0; }
            .main-content { width: 100%; }
            header { padding: 0 10px; }
            #content-area { padding: 10px; }
            .bucket-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
            .profile-stats-grid { grid-template-columns: repeat(2, 1fr); }
            .modal-content-comment { flex-direction: column; height: 100%; width: 100%; border-radius: 0; }
            .modal-left { height: 40%; }
            .modal-content-profile { width: 100%; height: 100%; border-radius: 0; }
            .historia-img-container { height: 200px; }
        }
    </style>
</head>
<body>

    <div id="copyFeedback" style="position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:10px 20px; border-radius:20px; z-index:3000; display:none;">Frase copiada!</div>

    <div id="login-screen" class="login-overlay">
        <div class="login-box">
            <h2>RPG Naruto</h2>
            <input type="email" id="emailInput" placeholder="E-mail">
            <input type="password" id="passwordInput" placeholder="Senha">
            <button id="btnLogin">Entrar</button>
            <p style="font-size: 12px; margin-top: 15px; color:#777;">Não possui uma conta? Fale com o administrador.</p>
            <p id="msgError" style="color: red; font-size: 12px; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="app-container" style="display: none;">
        <div class="sidebar-overlay" onclick="toggleMobileMenu()"></div>
        
        <aside class="sidebar">
            <div class="logo"><i class="fa-solid fa-scroll"></i> RPG NARUTO</div>
            <nav>
                <button id="side-btn-dashboard" onclick="showTab('dashboard')" class="active"><i class="fa-solid fa-chart-line"></i> Dashboard</button>
                <button id="side-btn-inventario" onclick="showTab('inventario')"><i class="fa-solid fa-box-open"></i> Inventário</button>
                <button id="side-btn-missoes" onclick="showTab('missoes')"><i class="fa-solid fa-scroll"></i> Missões</button>
                <button id="side-btn-personagens" onclick="showTab('personagens')"><i class="fa-solid fa-users"></i> Personagens</button>
                <button id="side-btn-loja" onclick="showTab('loja')"><i class="fa-solid fa-store"></i> Loja</button>
                <button id="side-btn-rankings" onclick="showTab('rankings')"><i class="fa-solid fa-trophy"></i> Rankings</button>
                <button id="btn-admin-panel" onclick="showTab('admin-panel')"><i class="fa-solid fa-user-shield"></i> Painel Kage</button>
            </nav>
        </aside>

        <main class="main-content">
            <header>
                <button id="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="fa-solid fa-bars"></i></button>
                <nav class="top-nav">
                    <button id="nav-btn-feed" onclick="showTab('feed')" class="top-btn active">Feed</button>
                    <button id="nav-btn-jutsus" onclick="showTab('jutsus')" class="top-btn">Jutsus</button>
                    <button id="nav-btn-ferramentas" onclick="showTab('ferramentas')" class="top-btn">Ferramentas</button>
                    <button id="nav-btn-historia" onclick="showTab('historia')" class="top-btn">História</button>
                    <button id="nav-btn-frases" onclick="showTab('frases')" class="top-btn">Frases</button>
                </nav>
                <div class="user-area">
                    <span class="ryos"><i class="fa-solid fa-coins"></i> <span id="ryos-text">...</span></span>
                    <div class="profile-circle" onclick="toggleMenu()">
                        <img id="header-avatar" src="https://placehold.co/40x40/orange/white?text=N" alt="Avatar">
                    </div>
                    <div id="user-menu" class="dropdown-menu">
                        <div class="user-info" style="padding:10px 15px; font-weight:bold; border-bottom:1px solid var(--border-color);">...</div>
                        <div class="dropdown-item" onclick="openEditProfileModal()"><i class="fa-solid fa-user-pen"></i> Perfil e Personagem</div>
                        <div class="dropdown-item" onclick="openChangePasswordModal()"><i class="fa-solid fa-lock"></i> Alterar Senha</div>
                        <div class="dropdown-item" onclick="renderFeed('saved')"><i class="fa-regular fa-bookmark"></i> Salvos</div>
                        <div class="dropdown-item" onclick="renderFeed('all')"><i class="fa-solid fa-globe"></i> Feed Geral</div>
                        <div class="dropdown-item" onclick="fazerLogout()" style="color:var(--danger-color);"><i class="fa-solid fa-arrow-right-from-bracket"></i> Sair</div>
                    </div>
                </div>
            </header>

            <div id="content-area">
                <div id="feed" class="tab-content active">
                    <div class="create-post">
                        <textarea id="postInput" placeholder="No que você está pensando?" rows="2"></textarea>
                        <div id="preview-container" style="display:none; margin-top:10px; position:relative;">
                            <img id="preview-image" src="" style="max-width:100%; max-height:300px; border-radius:4px;">
                            <button onclick="removeImage()" style="position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.6); color:white; border:none; border-radius:50%; width:25px; height:25px;">×</button>
                        </div>
                        <div class="post-tools">
                            <label for="imageInput" style="cursor:pointer; color:var(--primary-color); font-weight:600; display:flex; align-items:center; gap:5px;">
                                <i class="fa-regular fa-image"></i> Foto/Vídeo
                            </label>
                            <input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload(event)" style="display:none;">
                            <button class="btn-post" onclick="publicarPost()">Publicar</button>
                        </div>
                    </div>
                    <div id="feed-container"><p style="text-align:center; color:#777; padding:20px;">Carregando feed...</p></div>
                </div>

                <div id="jutsus" class="tab-content"><h3>Meus Jutsus</h3><div class="bucket-grid" id="meus-jutsus-grid"><p>Carregando...</p></div><hr style="border:0; border-top:1px solid var(--border-color); margin:20px 0;"><h3>Loja de Jutsus</h3><div class="bucket-grid" id="loja-jutsus-grid"><p>Carregando...</p></div></div>
                <div id="ferramentas" class="tab-content"><h3>Loja de Ferramentas</h3><div class="bucket-grid" id="loja-ferramentas-grid"><p>Carregando...</p></div></div>
                
                 <div id="loja" class="tab-content">
                      <div class="shop-header">
                        <h3 style="margin-bottom:10px;">Localização Atual</h3>
                        <select id="shop-location" class="shop-location-select" onchange="atualizarFiltroVila()">
                            <option value="Konoha">Vila da Folha (Konoha)</option>
                            <option value="Suna">Vila da Areia (Suna)</option>
                            <option value="Kiri">Vila da Névoa (Kiri)</option>
                            <option value="Kumo">Vila da Nuvem (Kumo)</option>
                            <option value="Iwa">Vila da Pedra (Iwa)</option>
                            <option value="Ame">Vila da Chuva (Ame)</option>
                            <option value="Oto">Vila do Som (Oto)</option>
                            <option value="Kori">Vila do Gelo (Kori)</option>
                        </select>
                       <h3 style="margin:15px 0 10px;">Estabelecimentos</h3>
                        <div class="shop-categories">
                            <button class="shop-cat-btn active" onclick="filtrarLojaPorTipo('mercado', this)">Mercado</button>
                            <button class="shop-cat-btn" onclick="filtrarLojaPorTipo('comida', this)">Restaurantes</button>
                            <button class="shop-cat-btn" onclick="filtrarLojaPorTipo('remedio', this)">Hospital/Farmácia</button>
                            <button class="shop-cat-btn" onclick="filtrarLojaPorTipo('roupa', this)">Roupas</button>
                            <button class="shop-cat-btn" onclick="filtrarLojaPorTipo('acessorio', this)">Acessórios</button>
                            <button class="shop-cat-btn" onclick="filtrarLojaPorTipo('padaria', this)">Padaria</button>
                            <button class="shop-cat-btn" onclick="filtrarLojaPorTipo('floricultura', this)">Floricultura</button>
                            <button class="shop-cat-btn" onclick="filtrarLojaPorTipo('ferreiro', this)">Ferreiro</button>
                            <button class="shop-cat-btn" onclick="filtrarLojaPorTipo('biblioteca', this)">Biblioteca</button>
                        </div>
                    </div>
                    <h3>Itens à Venda</h3>
                    <div class="bucket-grid" id="loja-itens-grid"><p>Carregando...</p></div>
                </div>

                <div id="inventario" class="tab-content">
                    <h2>Meu Inventário</h2>
                    <div class="bucket-grid" id="inventario-grid"><p>Carregando itens...</p></div>
                </div>

                <div id="personagens" class="tab-content"><h2>Diretório de Ninjas</h2><div class="bucket-grid" id="directory-grid"><p>Carregando...</p></div></div>
                <div id="missoes" class="tab-content"><h2>Quadro de Missões</h2><div class="bucket-grid" id="missoes-grid"><p>Carregando...</p></div></div>
                <div id="rankings" class="tab-content"><h2>Rankings Globais</h2><div class="rankings-wrapper" id="ranking-container"><p>Carregando Rankings...</p></div></div>
                <div id="admin-panel" class="tab-content"><h2>Painel Kage</h2><div class="bucket-grid" id="admin-missoes-grid"><p>Carregando...</p></div></div>
                
                <div id="dashboard" class="tab-content">
                    <h2>Estatísticas do Ninja</h2>
                    <div class="level-container">
                        <div class="level-info"><span id="level-display">Nível 1</span><span id="xp-text-display">0 / 500 XP</span></div>
                        <div class="xp-bar-bg"><div class="xp-bar-fill" id="xp-bar"></div><div class="xp-text">Progresso</div></div>
                    </div>
                    <div class="profile-stats-grid">
                        <div class="stats-divider">Geral</div>
                        <div class="stat-card"><div class="stat-value" id="dash-nivel">1</div><div class="stat-label">Nível</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-cargo">Genin</div><div class="stat-label">Cargo</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-ryos">0</div><div class="stat-label">Ryos</div></div>
                        <div class="stats-divider">Batalha</div>
                        <div class="stat-card"><div class="stat-value" id="dash-wins">0</div><div class="stat-label">Vitórias</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-draws">0</div><div class="stat-label">Empates</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-loses">0</div><div class="stat-label">Derrotas</div></div>
                        <div class="stats-divider">Inventário</div>
                        <div class="stat-card"><div class="stat-value" id="dash-jutsus">0</div><div class="stat-label">Jutsus</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-tools">0</div><div class="stat-label">Ferramentas</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-items">0</div><div class="stat-label">Itens</div></div>
                        <div class="stats-divider">Vitalidade</div>
                        <div class="stat-card"><div class="stat-value" id="dash-vida">100</div><div class="stat-label">Vida</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-sanidade">100</div><div class="stat-label">Sanidade</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-chakra">100</div><div class="stat-label">Chakra</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-stamina">100</div><div class="stat-label">Stamina</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-controle">Baixo</div><div class="stat-label">Controle Chakra</div></div>
                        <div class="stats-divider">Atributos</div>
                        <div class="stat-card"><div class="stat-value" id="dash-forca">10</div><div class="stat-label">Força</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-defesa">10</div><div class="stat-label">Defesa</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-constituicao">10</div><div class="stat-label">Constituição</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-destreza">10</div><div class="stat-label">Destreza</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-intelecto">10</div><div class="stat-label">Intelecto</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-agilidade">10</div><div class="stat-label">Agilidade</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-velocidade">10</div><div class="stat-label">Velocidade</div></div>
                    </div>
                </div>
                
                <div id="historia" class="tab-content">
                    <div class="historia-container">
                        <div class="historia-img-container">
                            <img id="historia-display-img" src="https://img.freepik.com/vetores-gratis/fundo-de-paisagem-de-anime-de-design-plano_23-2149275367.jpg">
                            <button class="btn-edit-historia" onclick="window.editarHistoria()"><i class="fa-solid fa-pen"></i> Editar História</button>
                        </div>
                        <hr class="historia-divider">
                        <div class="historia-text-content" id="historia-display-text">A história do seu ninja aparecerá aqui.</div>
                    </div>
                </div>

                <div id="frases" class="tab-content">
                    <h2>Frases Marcantes</h2>
                    <div class="frase-input-area">
                        <input type="text" id="novaFraseInput" placeholder="Digite uma frase icônica...">
                        <button class="btn-post" onclick="window.adicionarFrase()">Adicionar</button>
                    </div>
                    <div class="frases-list" id="frases-list-container"><p style="color:#777; text-align:center;">Carregando frases...</p></div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay-comment" id="jutsuModal" style="z-index: 2001;">
        <div class="modal-content-card">
            <span class="close-modal" onclick="fecharJutsuModal()" style="color: #333; top: 10px; right: 15px;">&times;</span>
            <img id="jutsu-img-modal" src="" class="jutsu-modal-img">
            <h2 id="jutsu-name-modal" style="color:var(--primary-color);"></h2>
            <div id="jutsu-rank-modal" class="jutsu-modal-rank"></div>
            <div id="jutsu-stats-row" class="jutsu-stats-row"></div>
            <p id="jutsu-desc-modal" style="margin-top:10px;"></p>
            <div id="jutsu-price-modal" class="jutsu-modal-price"></div>
        </div>
    </div>
    
    <div class="modal-overlay-comment" id="toolModal" style="z-index: 2001;">
        <div class="modal-content-card" style="border-color: #555;">
            <span class="close-modal" onclick="fecharToolModal()" style="color: #333; top: 10px; right: 15px;">&times;</span>
            <img id="tool-img-modal" src="" class="jutsu-modal-img" style="border-color:#555;">
            <h2 id="tool-name-modal" style="color: #333;"></h2>
            <div id="tool-rank-modal" class="jutsu-modal-rank" style="background-color: #555;"></div>
            <p id="tool-desc-modal" style="margin-top:10px;"></p>
            <div id="tool-price-modal" class="jutsu-modal-price" style="border-color:#555; color:#555;"></div>
        </div>
    </div>

    <div class="modal-overlay-comment" id="itemModal" style="z-index: 2001;">
        <div class="modal-content-card" style="border-color: #2ecc71;">
            <span class="close-modal" onclick="fecharItemModal()" style="color: #333; top: 10px; right: 15px;">&times;</span>
            <img id="item-img-modal" src="" class="jutsu-modal-img" style="border-color:#2ecc71;">
            <h2 id="item-name-modal" style="color: #333;"></h2>
            <div id="item-rank-modal" class="jutsu-modal-rank" style="background-color: #2ecc71;"></div>
            <p id="item-desc-modal" style="margin-top:10px;"></p>
            <div id="item-price-modal" class="jutsu-modal-price" style="border-color:#2ecc71; color:#2ecc71;"></div>
        </div>
    </div>

    <div class="modal-overlay-comment" id="missaoModal" style="z-index: 2001;">
        <div class="modal-content-card" style="border-color: #e6b800; max-width: 500px;">
            <span class="close-modal" onclick="fecharMissaoModal()" style="color: #333; top: 10px; right: 15px;">&times;</span>
            <img id="missao-img-modal" src="" class="jutsu-modal-img" style="border-color:#e6b800; height: 150px;">
            <h2 id="missao-name-modal" style="color: #e6b800;"></h2>
            <div style="text-align: left; margin-bottom: 20px; max-height: 200px; overflow-y: auto; padding-right: 5px;">
                <p id="missao-desc-modal" style="color: #555; line-height: 1.6;"></p>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #e6b800; padding-top: 15px;">
                <div style="font-weight: bold; color: #2ecc71;">XP: <span id="missao-xp-modal">0</span> | Ryos: <span id="missao-reward-modal"></span></div>
                <div id="missao-actions-modal"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay-comment" id="profileModal" style="z-index: 2002;">
        <div class="modal-content-profile">
            <span class="close-modal" onclick="fecharProfileModal()" style="color: white; top: 15px; right: 15px;">&times;</span>
            <div class="profile-header"><div class="profile-avatar-large"><img src="" id="profile-modal-img"></div><h2 id="profile-modal-name" style="color:white;"></h2><p id="profile-modal-char" style="opacity:0.9;"></p></div>
            <div class="profile-body">
                <div class="profile-section-title">Estatísticas</div>
                <div class="profile-stats-grid" id="other-profile-stats"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay-comment" id="commentModal"><span class="close-modal" onclick="closeModal()">&times;</span><div class="modal-content-comment"><div class="modal-left" id="modalPostContent"></div><div class="modal-right"><div style="padding: 15px; border-bottom: 1px solid #eee;">Comentários</div><div class="comments-list" id="commentsList"></div><div class="comment-input-area"><input type="text" id="newCommentText" placeholder="Comentar..."><button onclick="submitComment()" style="border:none; background:none; color:var(--primary-color); font-weight:bold;">Enviar</button></div></div></div></div>
    <div class="modal-overlay-comment" id="editProfileModal" style="z-index: 2003;"><div class="modal-content-card"><span class="close-modal" onclick="closeEditProfileModal()" style="color: #333; top: 10px; right: 15px;">&times;</span><h3>Editar Perfil</h3><img id="edit-avatar-preview" src="" style="width:80px; height:80px; border-radius:50%; margin:10px auto; display:block;"><label for="edit-avatar-input" class="btn-post" style="display:block; width: fit-content; margin: 10px auto;">Escolher Foto</label><input type="file" id="edit-avatar-input" hidden accept="image/*" onchange="handleAvatarPreview(event)"><input type="text" id="edit-name-input" class="edit-input" placeholder="Nome do Personagem"><input type="text" id="edit-nick-input" class="edit-input" placeholder="Apelido"><button class="btn-post" onclick="salvarPerfil()" style="width: 100%;">Salvar</button></div></div>
    <div class="modal-overlay-comment" id="changePasswordModal" style="z-index: 2004;"><div class="modal-content-card"><span class="close-modal" onclick="closeChangePasswordModal()" style="color: #333; top: 10px; right: 15px;">&times;</span><h3>Alterar Senha</h3><input type="password" id="new-password" class="edit-input" placeholder="Nova Senha" style="margin-top:20px;"><button class="btn-post" onclick="salvarNovaSenha()" style="width: 100%;">Atualizar Senha</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, updateDoc, arrayUnion, arrayRemove, deleteDoc, increment, addDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyC3HOor32_p5Z-iADm0VgZ279rt1kj8ICg", authDomain: "rpg-naruto-5150a.firebaseapp.com", projectId: "rpg-naruto-5150a", storageBucket: "rpg-naruto-5150a.firebasestorage.app", messagingSenderId: "1007094335306", appId: "1:1007094335306:web:ac96fa96f9494f90fd63b3" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserData = null;
        let currentImageBase64 = null;
        let currentOpenPostId = null;
        let newAvatarBase64 = null;
        let globalXpTable = [];
        let vilaAtual = "Konoha";
        let lojaAtual = "geral";
        let globalItensMap = {}; // Cache para itens e ferramentas para o inventário

        const IMG_PADRAO = "https://img.freepik.com/vetores-gratis/ilustracao-de-pergaminho-ninja-desenhada-a-mao_23-2151159846.jpg";

        function calcularTempo(t) { if (!t) return "Agora"; const d = t.toDate(), n = new Date(), df = Math.floor((n - d) / 1000); if (df < 60) return "Agora"; if (df < 3600) return `Há ${Math.floor(df / 60)} min`; if (df < 86400) return `Há ${Math.floor(df / 3600)} h`; return d.toLocaleDateString('pt-BR'); }
        window.toggleMobileMenu = () => { document.querySelector('.sidebar').classList.toggle('mobile-active'); document.querySelector('.sidebar-overlay').classList.toggle('active'); };
        const btnLogin = document.getElementById('btnLogin');
        if(btnLogin) btnLogin.addEventListener('click', () => { const e = document.getElementById('emailInput').value, s = document.getElementById('passwordInput').value; if(!e || !s) return alert("Preencha tudo!"); btnLogin.innerText = "Carregando..."; signInWithEmailAndPassword(auth, e, s).catch((err) => { btnLogin.innerText = "Entrar"; alert(err.message); }); });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                if(user.email === "admin@rpgnaruto.com") document.getElementById('btn-admin-panel').style.display = 'flex';
                await carregarConfiguracoes();
                // Carregar cache de itens/ferramentas para inventário rápido
                await carregarCacheItens();
                
                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                    if(!currentUserData.inventario) currentUserData.inventario = {}; // Garantir que existe
                    atualizarInterface(currentUserData);
                    carregarTudo();
                } else {
                    const dadosPadrao = { nome: "Novo Ninja", ryos: 100, xp: 0, nivel: 1, email: user.email, meusJutsus: [], inventario: {}, statusMissoes: {} };
                    await setDoc(docRef, dadosPadrao);
                    currentUserData = dadosPadrao;
                    atualizarInterface(dadosPadrao);
                    carregarTudo();
                }
                try { window.renderFeed('all'); } catch(e) {}
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }
        });

        async function carregarConfiguracoes() { try { const s = await getDoc(doc(db, "game_config", "sistema_nivel")); if(s.exists()) globalXpTable = s.data().tabela_xp || []; } catch(e) {} }
        async function carregarCacheItens() {
            const s1 = await getDocs(collection(db, "itens")); s1.forEach(d => globalItensMap[d.id] = { ...d.data(), type: 'item' });
            const s2 = await getDocs(collection(db, "ferramentas")); s2.forEach(d => globalItensMap[d.id] = { ...d.data(), type: 'tool' });
        }

        function carregarTudo() {
            carregarLoja(); carregarMeusJutsus(currentUserData.meusJutsus);
            carregarLojaFerramentas(); 
            carregarLojaItens(); 
            carregarInventario(); // Novo
            carregarMissoes(); carregarRankings(); carregarFrases(); 
            if(auth.currentUser.email === "admin@rpgnaruto.com") carregarPainelAdmin();
        }

        function formatarNum(v) { return Number(v||0).toLocaleString('pt-BR'); }

        function atualizarInterface(dados) {
            document.querySelector('.user-info').innerText = dados.apelido || dados.nome || "Ninja";
            document.getElementById('ryos-text').innerText = formatarNum(dados.ryos);
            if(dados.avatar) document.getElementById('header-avatar').src = dados.avatar;
            const nivel = dados.nivel || 1, xpAtual = dados.xp || 0;
            const xpNecessario = globalXpTable[nivel] ? globalXpTable[nivel] : (nivel * 500); 
            const porcentagem = Math.min((xpAtual / xpNecessario) * 100, 100);
            document.getElementById('level-display').innerText = "Nível " + nivel;
            document.getElementById('xp-text-display').innerText = `${xpAtual} / ${xpNecessario} XP`;
            document.getElementById('xp-bar').style.width = porcentagem + "%";

            // Stats
            const set = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
            set('dash-nivel', nivel); set('dash-cargo', dados.cargo||"Genin"); set('dash-ryos', formatarNum(dados.ryos));
            set('dash-jutsus', dados.meusJutsus?.length||0); 
            
            // Contagem Inventário
            let totalItems = 0, totalTools = 0;
            if(dados.inventario) {
                for(let id in dados.inventario) {
                   if(globalItensMap[id]) {
                       if(globalItensMap[id].type === 'tool') totalTools += dados.inventario[id];
                       else totalItems += dados.inventario[id];
                   }
                }
            }
            set('dash-tools', totalTools); set('dash-items', totalItems);

            set('dash-wins', dados.vitorias||0); set('dash-loses', dados.derrotas||0); set('dash-draws', dados.empates||0);
            set('dash-vida', dados.vida||100); set('dash-sanidade', dados.sanidade||100);
            set('dash-chakra', dados.chakra||100); set('dash-stamina', dados.stamina||100); set('dash-controle', dados.controle_chakra||"Baixo");
            set('dash-forca', dados.forca||10); set('dash-defesa', dados.defesa||10); set('dash-constituicao', dados.constituicao||10);
            set('dash-destreza', dados.destreza||10); set('dash-intelecto', dados.intelecto||10); set('dash-agilidade', dados.agilidade||10); set('dash-velocidade', dados.velocidade||10);
        }

        function comprimirImagem(file) { return new Promise((resolve, reject) => { const r = new FileReader(); r.readAsDataURL(file); r.onload = (e) => { const i = new Image(); i.src = e.target.result; i.onload = () => { const c = document.createElement('canvas'), MAX = 600; let w = i.width, h = i.height; if (w > MAX) { h *= MAX / w; w = MAX; } c.width = w; c.height = h; c.getContext('2d').drawImage(i, 0, 0, w, h); resolve(c.toDataURL('image/jpeg', 0.7)); }; }; r.onerror = reject; }); }

        window.showTab = (t) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(t).classList.add('active');
            document.querySelectorAll('.top-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
            const btnTop = document.getElementById('nav-btn-'+t);
            const btnSide = document.getElementById('side-btn-'+t);
            if(btnTop) btnTop.classList.add('active');
            if(btnSide) btnSide.classList.add('active');
            if(t==='personagens') carregarPersonagens();
            if(t==='frases') carregarFrases();
            if(t==='inventario') carregarInventario();
            if(window.innerWidth <= 768) window.toggleMobileMenu();
        };

        window.toggleMenu = () => document.getElementById('user-menu').classList.toggle('show');
        window.fazerLogout = () => signOut(auth).then(() => location.reload());
        
        // --- FUNÇÕES DE PERFIL E SENHA ---
        window.openEditProfileModal = () => { document.getElementById('editProfileModal').style.display = 'flex'; document.getElementById('edit-name-input').value = currentUserData.nome || ""; document.getElementById('edit-nick-input').value = currentUserData.apelido || ""; document.getElementById('user-menu').classList.remove('show'); };
        window.closeEditProfileModal = () => document.getElementById('editProfileModal').style.display = 'none';
        window.handleAvatarPreview = async (e) => { if(e.target.files[0]) { newAvatarBase64 = await comprimirImagem(e.target.files[0]); document.getElementById('edit-avatar-preview').src = newAvatarBase64; } };
        window.salvarPerfil = async () => { const nome = document.getElementById('edit-name-input').value; const apelido = document.getElementById('edit-nick-input').value; const updates = { nome: nome, apelido: apelido, personagem: nome }; if(newAvatarBase64) updates.avatar = newAvatarBase64; await updateDoc(doc(db, "users", auth.currentUser.uid), updates); location.reload(); };
        window.openChangePasswordModal = () => { document.getElementById('changePasswordModal').style.display='flex'; document.getElementById('user-menu').classList.remove('show'); };
        window.closeChangePasswordModal = () => document.getElementById('changePasswordModal').style.display='none';
        window.salvarNovaSenha = async () => { const p = document.getElementById('new-password').value; if(!p || p.length < 6) return alert("Mínimo 6 caracteres"); try { await updatePassword(auth.currentUser, p); alert("Sucesso!"); closeChangePasswordModal(); } catch(e) { alert("Erro: " + e.message); } };

        // --- FILTROS LOJA ---
        window.atualizarFiltroVila = () => { vilaAtual = document.getElementById('shop-location').value; carregarLojaItens(); };
        window.filtrarLojaPorTipo = (t, b) => { lojaAtual = t; document.querySelectorAll('.shop-cat-btn').forEach(x => x.classList.remove('active')); b.classList.add('active'); carregarLojaItens(); };

        // --- RENDERIZADORES DE CARD ---
        function criarCard(containerId, dados, id, tipo, clickFn, qtd = null) {
            const c = document.getElementById(containerId); if(!c) return;
            const div = document.createElement('div'); div.className = 'card'; div.onclick = () => clickFn(id, dados);
            let sub = "", extra = "";
            if(tipo === 'jutsu') {
                sub = "Rank " + dados.rank;
                if(currentUserData.maestrias) extra = `<span class="maestria-display">Maestria: ${currentUserData.maestrias[id]||0}</span>`;
            } else if(tipo === 'ferramenta') sub = dados.dano || "Ferramenta";
            else sub = dados.efeito || "Item";
            
            if(qtd !== null) {
                // Se for inventário, adiciona o botão de MENOS
                extra += `<div class="inventory-controls"><span class="qtd-badge">x${qtd}</span><button class="btn-minus" onclick="consumirItem('${id}', '${dados.nome}'); event.stopPropagation();">-</button></div>`;
            }

            div.innerHTML = `<img src="${dados.imagem||IMG_PADRAO}" class="card-img-top"><h4>${dados.nome}</h4><small>${sub}</small>${extra}`;
            c.appendChild(div);
        }
        function criarCardLoja(containerId, dados, id, tipo, buyFn, clickFn) {
            const c = document.getElementById(containerId); if(!c) return;
            const div = document.createElement('div'); div.className = 'card'; div.onclick = (e) => { if(!e.target.classList.contains('buy-btn')) clickFn(id, dados); };
            let sub = "";
            if(tipo === 'jutsu') sub = "Rank " + dados.rank; else if(tipo === 'ferramenta') sub = dados.dano || "Ferramenta"; else sub = dados.efeito || "Item";
            div.innerHTML = `<img src="${dados.imagem||IMG_PADRAO}" class="card-img-top"><h4>${dados.nome}</h4><small>${sub}</small><p style="color:var(--primary-color); font-weight:bold;">${formatarNum(dados.preco)} Ryos</p><button class="buy-btn">Comprar</button>`;
            div.querySelector('.buy-btn').onclick = (e) => { e.stopPropagation(); buyFn(id, dados.preco, dados.nome); };
            c.appendChild(div);
        }

        // --- LOADERS ---
        async function carregarLoja() {
            const c = document.getElementById('loja-jutsus-grid'); if(!c) return; c.innerHTML = '';
            const m = currentUserData.meusJutsus || [];
            const snap = await getDocs(collection(db, "jutsus"));
            snap.forEach(d => { const i = d.data(); const p = i.restrito_a || []; if(p.length > 0 && !p.includes(currentUserData.nome)) return; if(!m.includes(d.id)) criarCardLoja('loja-jutsus-grid', i, d.id, 'jutsu', (id, p, n) => comprarJutsu(id, p, n), (id, i) => verDetalhesJutsu(id, i)); });
        }
        async function carregarMeusJutsus(l) {
            const c = document.getElementById('meus-jutsus-grid'); if(!c) return; c.innerHTML = '';
            if(!l || l.length === 0) { c.innerHTML = '<p>Vazio.</p>'; return; }
            for(const id of l) { const s = await getDoc(doc(db, "jutsus", id)); if(s.exists()) criarCard('meus-jutsus-grid', s.data(), id, 'jutsu', (id, i) => verDetalhesJutsu(id, i)); }
        }
        async function carregarLojaFerramentas() {
            const c = document.getElementById('loja-ferramentas-grid'); if(!c) return; c.innerHTML = '';
            const snap = await getDocs(collection(db, "ferramentas"));
            snap.forEach(d => { criarCardLoja('loja-ferramentas-grid', d.data(), d.id, 'ferramenta', (id, p, n) => comprarFerramenta(id, p, n), (id, i) => verDetalhesFerramenta(id, i)); });
        }
        async function carregarLojaItens() {
            const c = document.getElementById('loja-itens-grid'); if(!c) return; c.innerHTML = '';
            const snap = await getDocs(collection(db, "itens"));
            snap.forEach(d => {
                const i = d.data();
                let vilaOk = false;
                if(!i.vila || i.vila === 'Global') vilaOk = true;
                else if(Array.isArray(i.vila)) { if(i.vila.includes(vilaAtual) || i.vila.includes('Global')) vilaOk = true; }
                else if(i.vila === vilaAtual) vilaOk = true;

                if (lojaAtual !== 'geral' && i.tipo !== lojaAtual) return;
                if (!vilaOk) return;

                criarCardLoja('loja-itens-grid', i, d.id, 'item', (id, p, n) => comprarItem(id, p, n), (id, i) => verDetalhesItem(id, i));
            });
        }

        // --- INVENTÁRIO (NOVO) ---
        async function carregarInventario() {
            const c = document.getElementById('inventario-grid'); if(!c) return; c.innerHTML = '';
            const inv = currentUserData.inventario || {};
            const keys = Object.keys(inv);
            
            // FILTRA APENAS ITENS COM QTD > 0
            const validKeys = keys.filter(k => inv[k] > 0);
            
            if(validKeys.length === 0) { c.innerHTML = '<p>Mochila vazia.</p>'; return; }
            
            validKeys.forEach(id => {
                const qtd = inv[id];
                const info = globalItensMap[id];
                if(info) {
                    criarCard('inventario-grid', info, id, info.type, (id, d) => {
                       if(info.type === 'tool') verDetalhesFerramenta(id, d);
                       else verDetalhesItem(id, d);
                    }, qtd);
                }
            });
        }

        // --- CONSUMO ---
        window.consumirItem = async (id, nome) => {
             if(!confirm(`Usar/Descartar 1x ${nome}?`)) return;
             // Decrementa 1
             await updateDoc(doc(db, "users", auth.currentUser.uid), {
                 [`inventario.${id}`]: increment(-1)
             });
             reloadData();
        };

        // --- COMPRA LOGIC (UPDATED FOR INVENTORY) ---
        window.comprarJutsu = async (id, p, n) => {
            if(!confirm(`Comprar ${n}?`)) return; if(currentUserData.ryos < p) return alert("Sem Ryos!");
            await updateDoc(doc(db, "users", auth.currentUser.uid), { ryos: increment(-p), meusJutsus: arrayUnion(id), [`maestrias.${id}`]: 0 });
            alert("Comprado!"); reloadData();
        };
        window.comprarFerramenta = async (id, p, n) => {
            if(!confirm(`Comprar ${n}?`)) return; if(currentUserData.ryos < p) return alert("Sem Ryos!");
            await updateDoc(doc(db, "users", auth.currentUser.uid), { ryos: increment(-p), [`inventario.${id}`]: increment(1) });
            alert("Comprado!"); reloadData();
        };
        window.comprarItem = async (id, p, n) => {
            if(!confirm(`Comprar ${n}?`)) return; if(currentUserData.ryos < p) return alert("Sem Ryos!");
            await updateDoc(doc(db, "users", auth.currentUser.uid), { ryos: increment(-p), [`inventario.${id}`]: increment(1) });
            alert("Comprado!"); reloadData();
        };
        async function reloadData() {
            const s = await getDoc(doc(db, "users", auth.currentUser.uid)); currentUserData = s.data(); atualizarInterface(currentUserData); carregarTudo();
        }

        // --- MODAL DETAILS ---
        function abrirModal(t, d) {
            let p = t; document.getElementById(p+'-name-modal').innerText = d.nome; document.getElementById(p+'-desc-modal').innerText = d.descricao||""; document.getElementById(p+'-price-modal').innerText = "Valor: "+formatarNum(d.preco)+" Ryos";
            const i = document.getElementById(p+'-img-modal'); i.src = d.imagem||IMG_PADRAO;
            if(t==='jutsu'){
                document.getElementById(p+'-rank-modal').innerText = "Rank "+d.rank;
                let h=""; if(d.dano) h+=`<span class="jutsu-stat-tag tag-dano">${d.dano}</span>`; if(d.chakra) h+=`<span class="jutsu-stat-tag tag-chakra">Chakra: ${d.chakra}</span>`; if(d.stamina) h+=`<span class="jutsu-stat-tag tag-stamina">Stamina: ${d.stamina}</span>`; if(d.bonus) h+=`<span class="jutsu-stat-tag tag-buff">${d.bonus}</span>`;
                document.getElementById('jutsu-stats-row').innerHTML = h;
            }
            if(t==='tool') document.getElementById(p+'-rank-modal').innerText = d.dano||"Ferramenta";
            if(t==='item') document.getElementById(p+'-rank-modal').innerText = d.efeito||"Item";
            document.getElementById(t+'Modal').style.display='flex';
        }
        window.verDetalhesJutsu = (i,d) => abrirModal('jutsu',d); window.verDetalhesFerramenta = (i,d) => abrirModal('tool',d); window.verDetalhesItem = (i,d) => abrirModal('item',d);
        window.fecharJutsuModal = () => document.getElementById('jutsuModal').style.display='none';
        window.fecharToolModal = () => document.getElementById('toolModal').style.display='none';
        window.fecharItemModal = () => document.getElementById('itemModal').style.display='none';

        // --- FEED ---
        window.handleImageUpload = async (e) => { if(e.target.files[0]) { try { currentImageBase64 = await comprimirImagem(e.target.files[0]); document.getElementById('preview-image').src = currentImageBase64; document.getElementById('preview-container').style.display='block'; } catch(e){alert("Erro imagem");} } };
        window.removeImage = () => { document.getElementById('imageInput').value=''; currentImageBase64=null; document.getElementById('preview-container').style.display='none'; };
        window.publicarPost = async () => {
            const t = document.getElementById('postInput').value; if(!t.trim() && !currentImageBase64) return alert("Escreva algo!");
            const btn = document.querySelector('.btn-post'); btn.innerText="..."; btn.disabled=true;
            try { await addDoc(collection(db, "posts"), { uid: auth.currentUser.uid, autor: currentUserData.apelido || "Ninja", autorAvatar: currentUserData.avatar, conteudo: t, imagem: currentImageBase64, data: serverTimestamp(), likes: [], savedBy: [], comments: [] }); document.getElementById('postInput').value=''; removeImage(); } catch(e) { alert("Erro."); } finally { btn.innerText="Publicar"; btn.disabled=false; }
        };
        window.renderFeed = (f) => {
            const c = document.getElementById('feed-container'); if(!c) return;
            onSnapshot(query(collection(db, "posts"), orderBy("data", "desc")), (s) => {
                c.innerHTML = ''; if(s.empty) { c.innerHTML = '<p style="text-align:center;">Nada aqui.</p>'; return; }
                s.forEach(d => {
                    const p = d.data(); if(f==='saved' && !p.savedBy.includes(auth.currentUser.uid)) return;
                    const isOwner = p.uid === auth.currentUser.uid;
                    const menu = isOwner ? `<div class="post-menu-container"><div class="post-options-btn" onclick="this.nextElementSibling.classList.toggle('active')">...</div><div class="post-dropdown"><div class="dropdown-item danger" onclick="deletarPost('${d.id}')">Excluir</div></div></div>` : '';
                    const div = document.createElement('div'); div.className='post';
                    div.innerHTML = `<div class="post-header"><div class="user-avatar-post"><img src="${p.autorAvatar||IMG_PADRAO}"></div><div class="post-info"><span class="post-author">${p.autor}</span><span class="post-time">${calcularTempo(p.data)}</span></div>${menu}</div><div class="post-content">${p.conteudo}</div>${p.imagem ? `<img src="${p.imagem}" class="post-image" onclick="verPost('${d.id}')">` : ''}<div class="post-actions"><button class="action-btn ${p.likes.includes(auth.currentUser.uid)?'liked':''}" onclick="toggleLike('${d.id}')"><i class="${p.likes.includes(auth.currentUser.uid)?'fa-solid':'fa-regular'} fa-heart"></i> ${p.likes.length}</button><button class="action-btn" onclick="verPost('${d.id}')"><i class="fa-regular fa-comment"></i> ${p.comments.length}</button><button class="action-btn ${p.savedBy.includes(auth.currentUser.uid)?'saved':''}" onclick="toggleSave('${d.id}')" style="margin-left:auto;"><i class="${p.savedBy.includes(auth.currentUser.uid)?'fa-solid':'fa-regular'} fa-bookmark"></i></button></div>`;
                    c.appendChild(div);
                });
            });
        };
        window.deletarPost = async (id) => { if(confirm("Apagar?")) await deleteDoc(doc(db, "posts", id)); };
        window.toggleLike = async (id) => { const r=doc(db,"posts",id), s=await getDoc(r), l=s.data().likes; if(l.includes(auth.currentUser.uid)) await updateDoc(r,{likes:arrayRemove(auth.currentUser.uid)}); else await updateDoc(r,{likes:arrayUnion(auth.currentUser.uid)}); };
        window.toggleSave = async (id) => { const r=doc(db,"posts",id), s=await getDoc(r), l=s.data().savedBy; if(l.includes(auth.currentUser.uid)) await updateDoc(r,{savedBy:arrayRemove(auth.currentUser.uid)}); else await updateDoc(r,{savedBy:arrayUnion(auth.currentUser.uid)}); };
        window.verPost = async (id) => { currentOpenPostId = id; const s = await getDoc(doc(db, "posts", id)), p = s.data(); document.getElementById('modalPostContent').innerHTML = p.imagem ? `<img src="${p.imagem}" style="width:100%;height:100%;object-fit:contain;">` : `<div style="padding:20px;">${p.conteudo}</div>`; document.getElementById('commentsList').innerHTML = p.comments.map(c=>`<div><b>${c.autor}</b>: ${c.texto}</div>`).join(''); document.getElementById('commentModal').style.display='flex'; };
        window.submitComment = async () => { const t = document.getElementById('newCommentText').value; if(!t) return; await updateDoc(doc(db, "posts", currentOpenPostId), { comments: arrayUnion({ autor: currentUserData.nome, texto: t }) }); document.getElementById('newCommentText').value = ""; verPost(currentOpenPostId); };
        window.closeModal = () => document.getElementById('commentModal').style.display = 'none';

        // --- CARREGADORES SECUNDÁRIOS ---
        async function carregarPersonagens() { const c = document.getElementById('directory-grid'); if(!c) return; const s = await getDocs(collection(db, "users")); c.innerHTML = ''; s.forEach(d => { const u = d.data(); const k = document.createElement('div'); k.className = 'card'; k.onclick = () => window.verPerfil(d.id); k.innerHTML = `<div style="width:60px; height:60px; border-radius:50%; overflow:hidden; margin:0 auto 10px;"><img src="${u.avatar||IMG_PADRAO}" style="width:100%; height:100%; object-fit:cover;"></div><h4>${u.nome}</h4><p>${u.apelido||""}</p>`; c.appendChild(k); }); }
        window.verPerfil = async (uid) => {
            const s = await getDoc(doc(db, "users", uid));
            if(s.exists()) {
                const u = s.data();
                document.getElementById('profile-modal-name').innerText = u.nome;
                document.getElementById('profile-modal-char').innerText = u.apelido || "";
                document.getElementById('profile-modal-img').src = u.avatar||IMG_PADRAO;
                
                const set = (id, v) => { if(document.getElementById(id)) document.getElementById(id).innerText = v; };
                // Stats
                set('prof-nivel', u.nivel||1); set('prof-cargo', u.cargo||"Genin"); set('prof-ryos', formatarNum(u.ryos));
                set('prof-jutsus', u.meusJutsus?.length||0); set('prof-wins', u.vitorias||0); set('prof-loses', u.derrotas||0); set('prof-draws', u.empates||0);
                
                // Atributos
                set('prof-vida', u.vida||100); set('prof-sanidade', u.sanidade||100); set('prof-chakra', u.chakra||100); set('prof-stamina', u.stamina||100); set('prof-controle', u.controle_chakra||"Baixo");
                set('prof-forca', u.forca||10); set('prof-defesa', u.defesa||10); set('prof-constituicao', u.constituicao||10); set('prof-destreza', u.destreza||10);
                set('prof-intelecto', u.intelecto||10); set('prof-agilidade', u.agilidade||10); set('prof-velocidade', u.velocidade||10);
                
                // Contar itens (apenas quantidade total para perfil alheio)
                let tTools = 0, tItems = 0;
                if(u.inventario) {
                    for(let k in u.inventario) {
                        if(globalItensMap[k]) {
                            if(globalItensMap[k].type === 'tool') tTools += u.inventario[k];
                            else tItems += u.inventario[k];
                        }
                    }
                }
                set('prof-tools', tTools); set('prof-items', tItems);

                document.getElementById('profileModal').style.display = 'flex';
            }
        };
        window.fecharProfileModal = () => document.getElementById('profileModal').style.display = 'none';
        
        async function carregarMissoes() { const c = document.getElementById('missoes-grid'); if(!c) return; const m = currentUserData.statusMissoes || {}; const s = await getDocs(collection(db, "missoes")); c.innerHTML = ''; s.forEach(d => { const i = d.data(), st = m[d.id] || 'neutro'; const k = document.createElement('div'); k.className = 'card jutsu-card-click'; k.onclick = () => verDetalhesMissao(d.id, i, st); k.innerHTML=`<h4>${i.titulo}</h4><p style="font-size:0.9rem; color:${st==='em_andamento'?'orange':st==='aprovado'?'green':'#777'}; font-weight:bold;">${st==='neutro'?'Disponível':st}</p><small style="color:var(--primary-color)">${i.xp||0} XP | ${formatarNum(i.recompensa)} Ryos</small>`; c.appendChild(k); }); }
        window.verDetalhesMissao = (id, d, st) => { document.getElementById('missao-name-modal').innerText = d.titulo; document.getElementById('missao-desc-modal').innerText = d.descricao; document.getElementById('missao-reward-modal').innerText = formatarNum(d.recompensa); document.getElementById('missao-xp-modal').innerText = d.xp||0; document.getElementById('missao-img-modal').src = d.imagem||IMG_PADRAO; const a = document.getElementById('missao-actions-modal'); a.innerHTML = ''; if(st==='neutro') a.innerHTML = `<button class="mission-btn-start" onclick="iniciarMissao('${id}')">Aceitar</button>`; else if(st==='aprovado') a.innerHTML = `<button class="mission-btn-collect" onclick="coletarRecompensa('${id}',${d.recompensa},${d.xp||0})">Receber</button>`; document.getElementById('missaoModal').style.display='flex'; };
        window.fecharMissaoModal = () => document.getElementById('missaoModal').style.display='none';
        
        window.iniciarMissao = async (id) => { await updateDoc(doc(db, "users", auth.currentUser.uid), { [`statusMissoes.${id}`]: 'em_andamento' }); alert("Iniciada!"); reloadData(); };
        window.coletarRecompensa = async (id, r, x) => { const u = currentUserData, nr = (u.ryos||0)+r, nx = (u.xp||0)+x; let lvl = u.nivel||1, req = globalXpTable[lvl] || (lvl*500); let upou = false; while(nx >= req) { nx -= req; lvl++; req = globalXpTable[lvl] || (lvl*500); upou = true; } await updateDoc(doc(db, "users", auth.currentUser.uid), { ryos: nr, xp: nx, nivel: lvl, [`statusMissoes.${id}`]: 'concluido' }); if(upou) alert("Level Up!"); else alert("Coletado!"); reloadData(); };

        window.carregarRankings = async () => { const c = document.getElementById('ranking-container'); if(!c) return; const s = await getDocs(collection(db, "users")); let l=[]; s.forEach(d=>l.push(d.data())); c.innerHTML=''; renderRank(c,"Ryos",l,'ryos'); renderRank(c,"Nível",l,'nivel'); };
        function renderRank(c,t,l,f) { const s=[...l].sort((a,b)=>(b[f]||0)-(a[f]||0)).slice(0,5); let h=`<div class="ranking-col"><h3>${t}</h3><table class="ranking-table">`; s.forEach((u,i)=>h+=`<tr><td>${i+1}. ${u.nome}</td><td>${formatarNum(u[f])}</td></tr>`); h+='</table></div>'; c.innerHTML+=h; }

        window.editarHistoria = async () => { const n=prompt("Texto:",currentUserData.historiaTexto||""); if(n){ const i=prompt("Imagem:",currentUserData.historiaImagem||""); updateDoc(doc(db,"users",auth.currentUser.uid),{historiaTexto:n,historiaImagem:i}).then(reloadData); } }
        async function carregarFrases() { const c = document.getElementById('frases-list-container'); onSnapshot(query(collection(db, "frases"), orderBy("data", "desc")), (s) => { c.innerHTML=''; s.forEach(d=>{ const f=d.data(); const k=document.createElement('div'); k.className='frase-item'; k.onclick=()=>copiarFrase(f.texto); k.innerHTML=`<div class="frase-content">"${f.texto}"</div><div class="frase-author">- ${f.autor}</div>`; c.appendChild(k); }); }); }
        window.adicionarFrase = async () => { const t=document.getElementById('novaFraseInput').value; if(t) await addDoc(collection(db,"frases"),{texto:t,autor:currentUserData.nome,uid:auth.currentUser.uid,data:serverTimestamp()}); document.getElementById('novaFraseInput').value=''; }
        window.copiarFrase = (t) => { navigator.clipboard.writeText(t).then(() => { const f=document.getElementById('copyFeedback'); f.style.display='block'; setTimeout(()=>f.style.display='none',2000); }); };

        async function carregarPainelAdmin() { const c = document.getElementById('admin-missoes-grid'); c.innerHTML='Carregando...'; const s = await getDocs(collection(db, "users")); c.innerHTML=''; s.forEach(u=>{ const d=u.data(), m=d.statusMissoes||{}; for(const [mid,st] of Object.entries(m)){ if(st==='em_andamento'){ const k=document.createElement('div'); k.className='card'; k.innerHTML=`<h4>${d.nome}</h4><p>${mid}</p><button class="mission-btn-collect" onclick="aprovarMissao('${u.id}','${mid}')">Aprovar</button>`; c.appendChild(k); } } }); }
        window.aprovarMissao = async (uid, mid) => { if(confirm("Aprovar?")) await updateDoc(doc(db, "users", uid), { [`statusMissoes.${mid}`]: 'aprovado' }); alert("Feito!"); reloadData(); };

    </script>
</body>
</html>
