<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPG Naruto</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-color: #fafafa;
            --sidebar-bg: #ffffff;
            --text-color: #262626;
            --primary-color: #ff5e00;
            --card-bg: #ffffff;
            --border-color: #dbdbdb;
            --green-color: #2ecc71;
            --yellow-color: #f1c40f;
            --danger-color: #ed4956;
            --ranking-gold: #ffd700;
            --ranking-silver: #c0c0c0;
            --ranking-bronze: #cd7f32;
        }
        body.dark-mode { --bg-color: #000000; --sidebar-bg: #000000; --text-color: #f5f5f5; --card-bg: #121212; --border-color: #363636; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-color); color: var(--text-color); height: 100vh; overflow: hidden; }

        /* LOGIN */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .login-box { background: white; padding: 30px; border-radius: 10px; width: 100%; max-width: 320px; text-align: center; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; }
        .login-box button { background: var(--primary-color); color: white; border: none; padding: 12px; width: 100%; cursor: pointer; border-radius: 5px; font-weight: bold; font-size: 16px; }

        /* LAYOUT */
        #app-container { display: flex; height: 100vh; position: relative; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 998; opacity: 0; transition: opacity 0.3s; }
        .sidebar-overlay.active { display: block; opacity: 1; }
        .sidebar { width: 250px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 20px; overflow-y: auto; flex-shrink: 0; z-index: 999; transition: transform 0.3s ease; }
        .logo { font-size: 24px; font-weight: bold; color: var(--primary-color); margin-bottom: 40px; font-family: 'Segoe UI', sans-serif; letter-spacing: 1px; }
        .sidebar button { background: none; border: none; color: var(--text-color); width: 100%; text-align: left; padding: 12px 15px; cursor: pointer; border-radius: 8px; transition: 0.2s; display: flex; align-items: center; gap: 15px; margin-bottom: 5px; font-size: 1rem; }
        .sidebar button:hover, .sidebar button.active { background-color: rgba(0,0,0,0.05); font-weight: bold; color: var(--primary-color); }
        #btn-admin-panel { display: none; color: #ed4956; font-weight: bold; }

        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; width: 100%; }
        header { height: 60px; background: var(--sidebar-bg); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; flex-shrink: 0; z-index: 10; }
        #mobile-menu-btn { display: none; background: none; border: none; font-size: 1.5rem; color: var(--text-color); cursor: pointer; margin-right: 10px; }
        .top-nav { display: flex; gap: 15px; overflow-x: auto; flex: 1; margin-right: 10px; scrollbar-width: none; }
        .top-btn { background: none; border: none; padding: 10px 5px; color: #8e8e8e; cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; font-size: 0.9rem; font-weight: 500; }
        .top-btn.active { border-bottom-color: var(--primary-color); color: var(--text-color); font-weight: bold; }

        .user-area { display: flex; align-items: center; gap: 10px; position: relative; }
        .ryos { font-weight: bold; color: #e6b800; background: rgba(230, 184, 0, 0.1); padding: 5px 10px; border-radius: 15px; white-space: nowrap; font-size: 0.8rem; }
        .profile-circle { width: 35px; height: 35px; border-radius: 50%; overflow: hidden; cursor: pointer; border: 1px solid var(--border-color); flex-shrink: 0; }
        .profile-circle img { width: 100%; height: 100%; object-fit: cover; }
        .dropdown-menu { display: none; position: absolute; top: 50px; right: 0; background: var(--card-bg); border: 1px solid var(--border-color); width: 200px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 5px 0; z-index: 100; }
        .dropdown-menu.show { display: block; }
        .dropdown-item { display: block; padding: 12px 15px; color: var(--text-color); text-decoration: none; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 10px; }
        .dropdown-item:hover { background: rgba(0,0,0,0.03); }

        #content-area { padding: 20px; overflow-y: auto; background-color: var(--bg-color); flex: 1; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }

        /* CARDS E GRIDS */
        .bucket-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; margin-top: 20px; }
        .card { background: var(--card-bg); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); text-align: center; cursor: pointer; transition: 0.2s; overflow: hidden; }
        .card:hover { transform: translateY(-2px); border-color: var(--primary-color); }
        .card-img-top { width: 100%; height: 120px; object-fit: cover; border-radius: 4px; margin-bottom: 8px; border: 1px solid #eee; }
        
        .buy-btn { background-color: var(--primary-color); color: white; border: none; padding: 10px; width: 100%; border-radius: 5px; font-weight: bold; margin-top: 8px; font-size: 1rem; cursor: pointer; }
        .buy-btn:hover { background-color: #e05200; }
        
        /* MISSÕES E ADMIN */
        .mission-btn-start { background: var(--primary-color); color: white; border: none; padding: 10px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .mission-btn-collect { background: var(--green-color); color: white; border: none; padding: 10px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 5px; animation: pulse 1.5s infinite; }
        .mission-btn-wait { background: var(--yellow-color); color: #333; width: 100%; border: none; padding: 10px; border-radius: 5px; font-weight: bold; margin-top: 5px; cursor: not-allowed; }
        .mission-btn-done { background: #ccc; color: #666; width: 100%; border: none; padding: 10px; border-radius: 5px; font-weight: bold; margin-top: 5px; cursor: not-allowed; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* FEED */
        #feed { max-width: 600px; margin: 0 auto; width: 100%; }
        .create-post { background: var(--card-bg); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        .create-post textarea { width: 100%; padding: 10px; border: none; outline: none; background: transparent; color: var(--text-color); resize: none; font-size: 1rem; }
        .post-tools { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color); padding-top: 10px; margin-top: 10px; }
        .upload-btn { cursor: pointer; color: var(--primary-color); font-size: 0.9rem; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        #imageInput { display: none; }
        #preview-container { margin-top: 10px; display: none; position: relative; width: 100%; text-align: center; background: #000; border-radius: 4px; overflow: hidden; }
        #preview-image { max-width: 100%; max-height: 300px; object-fit: contain; }
        .remove-img { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-post { background: var(--primary-color); color: white; border: none; padding: 8px 20px; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        
        .post { background: var(--card-bg); border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border-color); position: relative; overflow: visible; }
        .post-header { display: flex; align-items: center; padding: 10px; }
        .user-avatar-post { width: 35px; height: 35px; border-radius: 50%; background: #efefef; margin-right: 10px; overflow: hidden; border: 1px solid var(--border-color); }
        .user-avatar-post img { width: 100%; height: 100%; object-fit: cover; }
        .post-info { display: flex; flex-direction: column; }
        .post-author { font-weight: 600; font-size: 0.95rem; color: var(--text-color); }
        .post-time { font-size: 0.75rem; color: #8e8e8e; }
        .post-menu-container { margin-left: auto; position: relative; }
        .post-options-btn { cursor: pointer; color: var(--text-color); padding: 8px; width: 30px; text-align: center; }
        .post-dropdown { display: none; position: absolute; top: 100%; right: 0; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; width: 140px; }
        .post-dropdown.active { display: block; }
        .post-dropdown-item { padding: 10px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: var(--text-color); }
        .post-dropdown-item.danger { color: var(--danger-color); }
        .post-content { padding: 0 10px 10px 10px; line-height: 1.5; white-space: pre-wrap; font-size: 0.95rem; }
        .post-image { width: 100%; height: auto; display: block; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); max-height: 600px; object-fit: cover; }
        .post-actions { display: flex; padding: 10px; gap: 15px; }
        .action-btn { background: none; border: none; cursor: pointer; color: var(--text-color); font-size: 1.5rem; display: flex; align-items: center; gap: 5px; padding: 0; }
        .action-btn.liked { color: var(--danger-color); }
        .edit-textarea { width: 100%; border: 1px solid var(--primary-color); border-radius: 4px; padding: 10px; margin: 10px 0; }

        /* RANKINGS RESTAURADOS */
        .rankings-wrapper { display: flex; gap: 20px; flex-wrap: wrap; padding-bottom: 20px; }
        .ranking-col { flex: 1 1 300px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; }
        .ranking-col h3 { color: var(--primary-color); text-align: center; margin-bottom: 15px; border-bottom: 2px solid var(--primary-color); font-size: 1.1rem; }
        .ranking-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .ranking-table td { padding: 8px; border-bottom: 1px solid var(--border-color); }

        /* MODAIS */
        .modal-overlay-comment { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .close-modal { position: absolute; top: 10px; left: 15px; font-size: 1.8rem; color: white; cursor: pointer; z-index: 20; text-shadow: 0 0 5px black; }
        .modal-content-card { background: var(--card-bg); padding: 30px; border-radius: 10px; width: 90%; max-width: 350px; text-align: center; position: relative; border: 1px solid var(--border-color); }
        .jutsu-modal-img { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .jutsu-modal-rank { display: inline-block; background: var(--primary-color); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; margin-bottom: 10px; }
        .jutsu-modal-price { color: var(--green-color); font-weight: bold; font-size: 1.2rem; border-top: 1px solid var(--border-color); padding-top: 15px; }
        .modal-content-profile { background: var(--card-bg); width: 90%; max-width: 800px; max-height: 90vh; border-radius: 15px; overflow-y: auto; position: relative; border: 1px solid var(--border-color); }
        .profile-header { background: linear-gradient(to right, #ff5e00, #ff9100); padding: 40px 20px; text-align: center; color: white; }
        .profile-avatar-large { width: 100px; height: 100px; border-radius: 50%; border: 4px solid white; margin: 0 auto 15px auto; overflow: hidden; background: #fff; }
        .profile-avatar-large img { width: 100%; height: 100%; object-fit: cover; }
        .profile-name { font-size: 1.8rem; font-weight: bold; }
        .profile-char { font-size: 1.1rem; opacity: 0.9; }
        .profile-body { padding: 20px; }
        .profile-stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); }
        .stat-label { font-size: 0.85rem; color: #777; margin-top: 5px; text-transform: uppercase; }
        .modal-content-comment { background: var(--card-bg); width: 90%; max-width: 900px; height: 80vh; border-radius: 4px; display: flex; overflow: hidden; position: relative; }
        .modal-left { flex: 1.5; background: #000; display: flex; align-items: center; justify-content: center; }
        .modal-left img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .modal-right { flex: 1; display: flex; flex-direction: column; background: var(--card-bg); border-left: 1px solid var(--border-color); }
        .comments-list { flex: 1; padding: 15px; overflow-y: auto; }
        .comment-input-area { padding: 15px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; }
        .comment-input-area input { flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 20px; outline: none; }
        .edit-input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 5px; }
        .edit-avatar-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); margin: 10px auto; display: block; }

        /* ESTILO HISTORIA RESTAURADO */
        .historia-container { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; max-width: 800px; margin: 0 auto; }
        .historia-img-container { width: 100%; height: 300px; background-color: #000; position: relative; }
        .historia-img-container img { width: 100%; height: 100%; object-fit: cover; }
        .historia-divider { height: 4px; background-color: #dbdbdb; border: none; margin: 0; }
        .historia-text-content { padding: 30px; line-height: 1.8; font-size: 1.1rem; color: var(--text-color); white-space: pre-wrap; }
        .btn-edit-historia { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.6); color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .btn-edit-historia:hover { background: var(--primary-color); }

        /* ESTILO FRASES RESTAURADO */
        .frase-input-area { background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 20px; display: flex; gap: 10px; }
        .frase-input-area input { flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; outline: none; }
        .frases-list { display: flex; flex-direction: column; gap: 10px; }
        .frase-item { background: var(--card-bg); padding: 20px; border-bottom: 1px solid #ccc; cursor: pointer; transition: background 0.2s; position: relative; border-radius: 5px; }
        .frase-item:hover { background-color: rgba(0,0,0,0.02); }
        .frase-content { font-size: 1.1rem; font-style: italic; margin-bottom: 5px; color: var(--text-color); }
        .frase-author { font-size: 0.85rem; color: var(--primary-color); font-weight: bold; text-align: right; }

        /* MOBILE */
        @media (max-width: 768px) {
            #mobile-menu-btn { display: block; }
            .sidebar { position: fixed; top: 0; left: -260px; height: 100%; box-shadow: 2px 0 10px rgba(0,0,0,0.3); transition: left 0.3s ease; }
            .sidebar.mobile-active { left: 0; }
            .main-content { width: 100%; }
            header { padding: 0 10px; }
            #content-area { padding: 10px; }
            .bucket-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
            .profile-stats-grid { grid-template-columns: repeat(2, 1fr); }
            .modal-content-comment { flex-direction: column; height: 100%; width: 100%; border-radius: 0; }
            .modal-left { height: 40%; }
            .modal-content-profile { width: 100%; height: 100%; border-radius: 0; }
            .historia-img-container { height: 200px; }
        }
    </style>
</head>
<body>

    <div id="copyFeedback" style="position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:10px 20px; border-radius:20px; z-index:3000; display:none;">Frase copiada!</div>

    <div id="login-screen" class="login-overlay">
        <div class="login-box">
            <h2>RPG Naruto</h2>
            <input type="email" id="emailInput" placeholder="E-mail">
            <input type="password" id="passwordInput" placeholder="Senha">
            <button id="btnLogin">Entrar</button>
            <p style="font-size: 12px; margin-top: 15px; color:#777;">Não possui uma conta? Fale com o administrador.</p>
            <p id="msgError" style="color: red; font-size: 12px; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="app-container" style="display: none;">
        <div class="sidebar-overlay" onclick="toggleMobileMenu()"></div>
        
        <aside class="sidebar">
            <div class="logo"><i class="fa-solid fa-scroll"></i> RPG NARUTO</div>
            <nav>
                <button onclick="showTab('dashboard')" class="active"><i class="fa-solid fa-chart-line"></i> Dashboard</button>
                <button onclick="showTab('missoes')"><i class="fa-solid fa-scroll"></i> Missões</button>
                <button onclick="showTab('personagens')"><i class="fa-solid fa-users"></i> Personagens</button>
                <button onclick="showTab('loja')"><i class="fa-solid fa-store"></i> Loja</button>
                <button onclick="showTab('rankings')"><i class="fa-solid fa-trophy"></i> Rankings</button>
                <button id="btn-admin-panel" onclick="showTab('admin-panel')"><i class="fa-solid fa-user-shield"></i> Painel Kage</button>
            </nav>
        </aside>

        <main class="main-content">
            <header>
                <button id="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="fa-solid fa-bars"></i></button>
                <nav class="top-nav">
                    <button id="nav-btn-feed" onclick="showTab('feed')" class="top-btn active">Feed</button>
                    <button id="nav-btn-jutsus" onclick="showTab('jutsus')" class="top-btn">Jutsus</button>
                    <button id="nav-btn-ferramentas" onclick="showTab('ferramentas')" class="top-btn">Ferramentas</button>
                    <button id="nav-btn-historia" onclick="showTab('historia')" class="top-btn">História</button>
                    <button id="nav-btn-frases" onclick="showTab('frases')" class="top-btn">Frases</button>
                </nav>
                <div class="user-area">
                    <span class="ryos"><i class="fa-solid fa-coins"></i> <span id="ryos-text">...</span></span>
                    <div class="profile-circle" onclick="toggleMenu()">
                        <img id="header-avatar" src="https://placehold.co/40x40/orange/white?text=N" alt="Avatar">
                    </div>
                    <div id="user-menu" class="dropdown-menu">
                        <div class="user-info" style="padding:10px 15px; font-weight:bold; border-bottom:1px solid var(--border-color);">...</div>
                        <div class="dropdown-item" onclick="openEditProfileModal()"><i class="fa-solid fa-user-pen"></i> Perfil e Personagem</div>
                        <div class="dropdown-item" onclick="renderFeed('saved')"><i class="fa-regular fa-bookmark"></i> Salvos</div>
                        <div class="dropdown-item" onclick="renderFeed('all')"><i class="fa-solid fa-globe"></i> Feed Geral</div>
                        <div class="dropdown-item" onclick="fazerLogout()" style="color:var(--danger-color);"><i class="fa-solid fa-arrow-right-from-bracket"></i> Sair</div>
                    </div>
                </div>
            </header>

            <div id="content-area">
                <div id="feed" class="tab-content active">
                    <div class="create-post">
                        <textarea id="postInput" placeholder="No que você está pensando?" rows="2"></textarea>
                        <div id="preview-container" style="display:none; margin-top:10px; position:relative;">
                            <img id="preview-image" src="" style="max-width:100%; max-height:300px; border-radius:4px;">
                            <button onclick="removeImage()" style="position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.6); color:white; border:none; border-radius:50%; width:25px; height:25px;">×</button>
                        </div>
                        <div class="post-tools">
                            <label for="imageInput" style="cursor:pointer; color:var(--primary-color); font-weight:600; display:flex; align-items:center; gap:5px;">
                                <i class="fa-regular fa-image"></i> Foto/Vídeo
                            </label>
                            <input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload(event)" style="display:none;">
                            <button class="btn-post" onclick="publicarPost()">Publicar</button>
                        </div>
                    </div>
                    <div id="feed-container"><p style="text-align:center; color:#777; padding:20px;">Carregando feed...</p></div>
                </div>

                <div id="jutsus" class="tab-content"><h3>Meus Jutsus</h3><div class="bucket-grid" id="meus-jutsus-grid"><p>Carregando...</p></div><hr style="border:0; border-top:1px solid var(--border-color); margin:20px 0;"><h3>Loja de Jutsus</h3><div class="bucket-grid" id="loja-jutsus-grid"><p>Carregando...</p></div></div>
                <div id="ferramentas" class="tab-content"><h3>Minhas Ferramentas</h3><div class="bucket-grid" id="minhas-ferramentas-grid"><p>Carregando...</p></div><hr style="border:0; border-top:1px solid var(--border-color); margin:20px 0;"><h3>Loja de Ferramentas</h3><div class="bucket-grid" id="loja-ferramentas-grid"><p>Carregando...</p></div></div>
                <div id="loja" class="tab-content"><h3>Meus Itens</h3><div class="bucket-grid" id="meus-itens-grid"><p>Carregando...</p></div><hr style="border:0; border-top:1px solid var(--border-color); margin:20px 0;"><h3>Mercado Geral</h3><div class="bucket-grid" id="loja-itens-grid"><p>Carregando...</p></div></div>
                <div id="personagens" class="tab-content"><h2>Diretório de Ninjas</h2><div class="bucket-grid" id="directory-grid"><p>Carregando...</p></div></div>
                <div id="missoes" class="tab-content"><h2>Quadro de Missões</h2><div class="bucket-grid" id="missoes-grid"><p>Carregando...</p></div></div>
                <div id="rankings" class="tab-content"><h2>Rankings Globais</h2><div class="rankings-wrapper" id="ranking-container"><p>Carregando Rankings...</p></div></div>
                <div id="admin-panel" class="tab-content"><h2>Painel Kage</h2><div class="bucket-grid" id="admin-missoes-grid"><p>Carregando...</p></div></div>
                
                <div id="dashboard" class="tab-content">
                    <h2>Estatísticas do Ninja</h2>
                    <div class="profile-stats-grid">
                        <div class="stat-card"><div class="stat-value" id="dash-nivel">1</div><div class="stat-label">Nível</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-cargo">Genin</div><div class="stat-label">Cargo</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-ryos">0</div><div class="stat-label">Ryos</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-jutsus">0</div><div class="stat-label">Jutsus</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-wins">0</div><div class="stat-label">Vitórias</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-draws">0</div><div class="stat-label">Empates</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-loses">0</div><div class="stat-label">Derrotas</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-tools">0</div><div class="stat-label">Ferramentas</div></div>
                        <div class="stat-card"><div class="stat-value" id="dash-items">0</div><div class="stat-label">Itens</div></div>
                    </div>
                </div>
                
                <div id="historia" class="tab-content">
                    <div class="historia-container">
                        <div class="historia-img-container">
                            <img id="historia-display-img" src="https://img.freepik.com/vetores-gratis/fundo-de-paisagem-de-anime-de-design-plano_23-2149275367.jpg" alt="Capa da História">
                            <button class="btn-edit-historia" onclick="editarHistoria()"><i class="fa-solid fa-pen"></i> Editar História</button>
                        </div>
                        <hr class="historia-divider">
                        <div class="historia-text-content" id="historia-display-text">
                            A história do seu ninja aparecerá aqui. Clique em "Editar História" para escrever sua lenda.
                        </div>
                    </div>
                </div>

                <div id="frases" class="tab-content">
                    <h2>Frases Marcantes</h2>
                    <div class="frase-input-area">
                        <input type="text" id="novaFraseInput" placeholder="Digite uma frase icônica...">
                        <button class="btn-post" onclick="adicionarFrase()">Adicionar</button>
                    </div>
                    <div class="frases-list" id="frases-list-container">
                        <p style="color:#777; text-align:center;">Carregando frases...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay-comment" id="jutsuModal" style="z-index: 2001;">
        <div class="modal-content-card">
            <span class="close-modal" onclick="fecharJutsuModal()" style="color: #333; top: 10px; right: 15px;">&times;</span>
            <img id="jutsu-img-modal" src="" class="jutsu-modal-img">
            <h2 id="jutsu-name-modal" style="color:var(--primary-color);"></h2>
            <div id="jutsu-rank-modal" class="jutsu-modal-rank"></div>
            <p id="jutsu-desc-modal" style="margin-top:10px;"></p>
            <div id="jutsu-price-modal" class="jutsu-modal-price"></div>
        </div>
    </div>
    
    <div class="modal-overlay-comment" id="toolModal" style="z-index: 2001;">
        <div class="modal-content-card" style="border-color: #555;">
            <span class="close-modal" onclick="fecharToolModal()" style="color: #333; top: 10px; right: 15px;">&times;</span>
            <img id="tool-img-modal" src="" class="jutsu-modal-img" style="border-color:#555;">
            <h2 id="tool-name-modal" style="color: #333;"></h2>
            <div id="tool-rank-modal" class="jutsu-modal-rank" style="background-color: #555;"></div>
            <p id="tool-desc-modal" style="margin-top:10px;"></p>
            <div id="tool-price-modal" class="jutsu-modal-price" style="border-color:#555; color:#555;"></div>
        </div>
    </div>

    <div class="modal-overlay-comment" id="itemModal" style="z-index: 2001;">
        <div class="modal-content-card" style="border-color: #2ecc71;">
            <span class="close-modal" onclick="fecharItemModal()" style="color: #333; top: 10px; right: 15px;">&times;</span>
            <img id="item-img-modal" src="" class="jutsu-modal-img" style="border-color:#2ecc71;">
            <h2 id="item-name-modal" style="color: #333;"></h2>
            <div id="item-rank-modal" class="jutsu-modal-rank" style="background-color: #2ecc71;"></div>
            <p id="item-desc-modal" style="margin-top:10px;"></p>
            <div id="item-price-modal" class="jutsu-modal-price" style="border-color:#2ecc71; color:#2ecc71;"></div>
        </div>
    </div>

    <div class="modal-overlay-comment" id="missaoModal" style="z-index: 2001;">
        <div class="modal-content-card" style="border-color: #e6b800; max-width: 500px;">
            <span class="close-modal" onclick="fecharMissaoModal()" style="color: #333; top: 10px; right: 15px;">&times;</span>
            <img id="missao-img-modal" src="" class="jutsu-modal-img" style="border-color:#e6b800; height: 150px;">
            <h2 id="missao-name-modal" style="color: #e6b800;"></h2>
            <p id="missao-desc-modal" style="margin-top:10px; max-height: 200px; overflow-y: auto;"></p>
            <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #e6b800; padding-top: 15px; margin-top: 15px;">
                <div style="font-weight: bold; color: #2ecc71;">Recompensa: <span id="missao-reward-modal"></span> Ryos</div>
                <div id="missao-actions-modal"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay-comment" id="profileModal" style="z-index: 2002;">
        <div class="modal-content-profile">
            <span class="close-modal" onclick="fecharProfileModal()" style="color: white; top: 15px; right: 15px;">&times;</span>
            <div class="profile-header">
                <div class="profile-avatar-large"><img src="" id="profile-modal-img"></div>
                <h2 id="profile-modal-name" style="color:white;"></h2>
                <p id="profile-modal-char" style="opacity:0.9;"></p>
            </div>
            <div class="profile-body">
                <div class="profile-section-title">Estatísticas</div>
                <div class="profile-stats-grid">
                    <div class="stat-card"><div class="stat-value" id="prof-nivel"></div><div class="stat-label">Nível</div></div>
                    <div class="stat-card"><div class="stat-value" id="prof-cargo"></div><div class="stat-label">Cargo</div></div>
                    <div class="stat-card"><div class="stat-value" id="prof-ryos"></div><div class="stat-label">Ryos</div></div>
                    <div class="stat-card"><div class="stat-value" id="prof-jutsus"></div><div class="stat-label">Jutsus</div></div>
                    <div class="stat-card"><div class="stat-value" id="prof-wins"></div><div class="stat-label">Vitórias</div></div>
                    <div class="stat-card"><div class="stat-value" id="prof-loses"></div><div class="stat-label">Derrotas</div></div>
                    <div class="stat-card"><div class="stat-value" id="prof-draws"></div><div class="stat-label">Empates</div></div>
                    <div class="stat-card"><div class="stat-value" id="prof-tools"></div><div class="stat-label">Ferramentas</div></div>
                    <div class="stat-card"><div class="stat-value" id="prof-items"></div><div class="stat-label">Itens</div></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay-comment" id="commentModal">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <div class="modal-content-comment">
            <div class="modal-left" id="modalPostContent"></div>
            <div class="modal-right">
                <div style="padding: 15px; border-bottom: 1px solid #eee;">Comentários</div>
                <div class="comments-list" id="commentsList"></div>
                <div class="comment-input-area"><input type="text" id="newCommentText" placeholder="Comentar..."><button onclick="submitComment()" style="border:none; background:none; color:var(--primary-color); font-weight:bold;">Enviar</button></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay-comment" id="editProfileModal" style="z-index: 2003;">
        <div class="modal-content-card">
            <span class="close-modal" onclick="closeEditProfileModal()" style="color: #333; top: 10px; right: 15px;">&times;</span>
            <h3>Editar Perfil</h3>
            <img id="edit-avatar-preview" src="" style="width:80px; height:80px; border-radius:50%; margin:10px auto; display:block;">
            <label for="edit-avatar-input" class="btn-post" style="display:block; width: fit-content; margin: 10px auto;">Escolher Foto</label>
            <input type="file" id="edit-avatar-input" hidden accept="image/*" onchange="handleAvatarPreview(event)">
            <input type="text" id="edit-name-input" class="edit-input" placeholder="Nome do Personagem">
            <input type="text" id="edit-nick-input" class="edit-input" placeholder="Apelido">
            <button class="btn-post" onclick="salvarPerfil()" style="width: 100%;">Salvar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, updateDoc, arrayUnion, arrayRemove, deleteDoc, increment, addDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC3HOor32_p5Z-iADm0VgZ279rt1kj8ICg",
            authDomain: "rpg-naruto-5150a.firebaseapp.com",
            projectId: "rpg-naruto-5150a",
            storageBucket: "rpg-naruto-5150a.firebasestorage.app",
            messagingSenderId: "1007094335306",
            appId: "1:1007094335306:web:ac96fa96f9494f90fd63b3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserData = null;
        let currentImageBase64 = null;
        let currentOpenPostId = null;
        let newAvatarBase64 = null;

        const IMG_PADRAO = "https://img.freepik.com/vetores-gratis/ilustracao-de-pergaminho-ninja-desenhada-a-mao_23-2151159846.jpg";

        // --- UI MOBILE ---
        window.toggleMobileMenu = () => {
            document.querySelector('.sidebar').classList.toggle('mobile-active');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        };

        // --- AUTH ---
        const btnLogin = document.getElementById('btnLogin');
        if(btnLogin) {
            btnLogin.addEventListener('click', () => {
                const email = document.getElementById('emailInput').value;
                const senha = document.getElementById('passwordInput').value;
                if(!email || !senha) return alert("Preencha tudo!");
                btnLogin.innerText = "Carregando...";
                signInWithEmailAndPassword(auth, email, senha).catch((e) => { btnLogin.innerText = "Entrar"; alert(e.message); });
            });
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                if(user.email === "admin@rpgnaruto.com") document.getElementById('btn-admin-panel').style.display = 'flex';

                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                    atualizarInterface(currentUserData);
                    carregarTudo();
                } else {
                    const dadosPadrao = { nome: "Novo Ninja", ryos: 100, email: user.email, meusJutsus: [], ferramentas: [], itens: [], statusMissoes: {} };
                    await setDoc(docRef, dadosPadrao);
                    currentUserData = dadosPadrao;
                    atualizarInterface(dadosPadrao);
                    carregarTudo();
                }
                try { window.renderFeed('all'); } catch(e) {}
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }
        });

        function carregarTudo() {
            carregarLoja(); carregarMeusJutsus(currentUserData.meusJutsus);
            carregarLojaFerramentas(); carregarMinhasFerramentas(currentUserData.ferramentas);
            carregarLojaItens(); carregarMeusItens(currentUserData.itens);
            carregarMissoes(); carregarRankings(); carregarFrases(); 
            // Painel admin simplificado
            if(auth.currentUser.email === "admin@rpgnaruto.com") carregarPainelAdmin();
        }

        function formatarNum(v) { return Number(v||0).toLocaleString('pt-BR'); }

        function atualizarInterface(dados) {
            document.querySelector('.user-info').innerText = dados.apelido || dados.nome || "Ninja";
            document.getElementById('ryos-text').innerText = formatarNum(dados.ryos);
            if(dados.avatar) document.getElementById('header-avatar').src = dados.avatar;
            if(dados.historiaTexto) document.getElementById('historia-display-text').innerText = dados.historiaTexto;
            if(dados.historiaImagem) document.getElementById('historia-display-img').src = dados.historiaImagem;

            // Atualiza Dashboard
            const set = (id, val) => { if(document.getElementById(id)) document.getElementById(id).innerText = val; };
            set('dash-nivel', dados.nivel || 1);
            set('dash-cargo', dados.cargo || "Genin");
            set('dash-ryos', formatarNum(dados.ryos));
            set('dash-jutsus', dados.meusJutsus?.length || 0);
            set('dash-tools', dados.ferramentas?.length || 0);
            set('dash-items', dados.itens?.length || 0);
            set('dash-wins', dados.vitorias || 0);
            set('dash-loses', dados.derrotas || 0);
            set('dash-draws', dados.empates || 0);
        }

        function comprimirImagem(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 600;
                        let w = img.width, h = img.height;
                        if (w > MAX_WIDTH) { h *= MAX_WIDTH / w; w = MAX_WIDTH; }
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
                reader.onerror = reject;
            });
        }

        // --- TAB SYSTEM ---
        window.showTab = (t) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(t).classList.add('active');
            document.querySelectorAll('.top-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById('nav-btn-'+t);
            if(btn) btn.classList.add('active');
            if(t==='personagens') carregarPersonagens();
            if(window.innerWidth <= 768) window.toggleMobileMenu(); 
        };

        window.toggleMenu = () => document.getElementById('user-menu').classList.toggle('show');
        window.fazerLogout = () => signOut(auth).then(() => location.reload());

        // --- PERFIL ---
        window.openEditProfileModal = () => {
            document.getElementById('editProfileModal').style.display = 'flex';
            document.getElementById('edit-name-input').value = currentUserData.nome || "";
            document.getElementById('edit-nick-input').value = currentUserData.apelido || "";
            document.getElementById('user-menu').classList.remove('show');
        };
        window.closeEditProfileModal = () => document.getElementById('editProfileModal').style.display = 'none';
        window.handleAvatarPreview = async (e) => {
            if(e.target.files[0]) { newAvatarBase64 = await comprimirImagem(e.target.files[0]); document.getElementById('edit-avatar-preview').src = newAvatarBase64; }
        };
        window.salvarPerfil = async () => {
            const nome = document.getElementById('edit-name-input').value;
            const apelido = document.getElementById('edit-nick-input').value;
            const updates = { nome: nome, apelido: apelido, personagem: nome };
            if(newAvatarBase64) updates.avatar = newAvatarBase64;
            await updateDoc(doc(db, "users", auth.currentUser.uid), updates);
            location.reload();
        };
        
        // --- CARREGAMENTO DE CARDS ---
        function criarCard(containerId, dados, id, tipo, clickFn) {
            const c = document.getElementById(containerId); if(!c) return;
            const img = dados.imagem || IMG_PADRAO;
            const div = document.createElement('div');
            div.className = 'card';
            div.onclick = () => clickFn(id, dados);
            let sub = "";
            if(tipo === 'jutsu') sub = "Rank " + dados.rank;
            else if(tipo === 'ferramenta') sub = dados.dano || "Ferramenta";
            else if(tipo === 'item') sub = dados.efeito || "Item";
            div.innerHTML = `<img src="${img}" class="card-img-top" onerror="this.src='${IMG_PADRAO}'"><h4>${dados.nome}</h4><small>${sub}</small>`;
            c.appendChild(div);
        }

        function criarCardLoja(containerId, dados, id, tipo, buyFn, clickFn) {
            const c = document.getElementById(containerId); if(!c) return;
            const img = dados.imagem || IMG_PADRAO;
            const div = document.createElement('div');
            div.className = 'card';
            div.onclick = (e) => { if(!e.target.classList.contains('buy-btn')) clickFn(id, dados); };
            let sub = "";
            if(tipo === 'jutsu') sub = "Rank " + dados.rank;
            else if(tipo === 'ferramenta') sub = dados.dano || "Ferramenta";
            else if(tipo === 'item') sub = dados.efeito || "Item";
            div.innerHTML = `<img src="${img}" class="card-img-top" onerror="this.src='${IMG_PADRAO}'"><h4>${dados.nome}</h4><small>${sub}</small><p style="color:var(--primary-color); font-weight:bold;">${formatarNum(dados.preco)} Ryos</p><button class="buy-btn">Comprar</button>`;
            div.querySelector('.buy-btn').onclick = (e) => { e.stopPropagation(); buyFn(id, dados.preco, dados.nome); };
            c.appendChild(div);
        }

        // --- LOJAS ---
        async function carregarLoja() {
            const c = document.getElementById('loja-jutsus-grid'); if(!c) return; c.innerHTML = '';
            const m = currentUserData.meusJutsus || [];
            const snap = await getDocs(collection(db, "jutsus"));
            snap.forEach(d => {
                const i = d.data();
                const permitidos = i.restrito_a || [];
                if(permitidos.length > 0 && !permitidos.includes(currentUserData.nome)) return;
                if(!m.includes(d.id)) criarCardLoja('loja-jutsus-grid', i, d.id, 'jutsu', (id, p, n) => comprar(id, p, n, 'meusJutsus'), (id, i) => verDetalhesJutsu(id, i));
            });
        }
        async function carregarMeusJutsus(lista) {
            const c = document.getElementById('meus-jutsus-grid'); if(!c) return; c.innerHTML = '';
            if(!lista || lista.length === 0) { c.innerHTML = '<p>Vazio.</p>'; return; }
            for(const id of lista) { const s = await getDoc(doc(db, "jutsus", id)); if(s.exists()) criarCard('meus-jutsus-grid', s.data(), id, 'jutsu', (id, i) => verDetalhesJutsu(id, i)); }
        }
        
        async function carregarLojaFerramentas() {
            const c = document.getElementById('loja-ferramentas-grid'); if(!c) return; c.innerHTML = '';
            const m = currentUserData.ferramentas || [];
            const snap = await getDocs(collection(db, "ferramentas"));
            snap.forEach(d => {
                if(!m.includes(d.id)) criarCardLoja('loja-ferramentas-grid', d.data(), d.id, 'ferramenta', (id, p, n) => comprar(id, p, n, 'ferramentas'), (id, i) => verDetalhesFerramenta(id, i));
            });
        }
        async function carregarMinhasFerramentas(lista) {
            const c = document.getElementById('minhas-ferramentas-grid'); if(!c) return; c.innerHTML = '';
            if(!lista || lista.length === 0) { c.innerHTML = '<p>Vazio.</p>'; return; }
            for(const id of lista) { const s = await getDoc(doc(db, "ferramentas", id)); if(s.exists()) criarCard('minhas-ferramentas-grid', s.data(), id, 'ferramenta', (id, i) => verDetalhesFerramenta(id, i)); }
        }

        async function carregarLojaItens() {
            const c = document.getElementById('loja-itens-grid'); if(!c) return; c.innerHTML = '';
            const snap = await getDocs(collection(db, "itens"));
            snap.forEach(d => {
                criarCardLoja('loja-itens-grid', d.data(), d.id, 'item', (id, p, n) => comprar(id, p, n, 'itens'), (id, i) => verDetalhesItem(id, i));
            });
        }
        async function carregarMeusItens(lista) {
            const c = document.getElementById('meus-itens-grid'); if(!c) return; c.innerHTML = '';
            if(!lista || lista.length === 0) { c.innerHTML = '<p>Vazio.</p>'; return; }
            for(const id of lista) { const s = await getDoc(doc(db, "itens", id)); if(s.exists()) criarCard('meus-itens-grid', s.data(), id, 'item', (id, i) => verDetalhesItem(id, i)); }
        }

        // --- COMPRA GENÉRICA ---
        async function comprar(id, preco, nome, campoDb) {
            if(!confirm(`Comprar ${nome}?`)) return;
            if(currentUserData.ryos < preco) return alert("Sem Ryos!");
            
            await updateDoc(doc(db, "users", auth.currentUser.uid), {
                ryos: increment(-preco),
                [campoDb]: arrayUnion(id)
            });
            alert("Comprado!");
            const snap = await getDoc(doc(db, "users", auth.currentUser.uid));
            currentUserData = snap.data();
            atualizarInterface(currentUserData);
            if(campoDb === 'meusJutsus') { carregarLoja(); carregarMeusJutsus(currentUserData.meusJutsus); }
            if(campoDb === 'ferramentas') { carregarLojaFerramentas(); carregarMinhasFerramentas(currentUserData.ferramentas); }
            if(campoDb === 'itens') { carregarLojaItens(); carregarMeusItens(currentUserData.itens); }
        }

        // --- MODAIS DE DETALHES ---
        function abrirModal(tipo, dados) {
            let prefix = tipo; // jutsu, tool, item
            document.getElementById(prefix + '-name-modal').innerText = dados.nome;
            document.getElementById(prefix + '-desc-modal').innerText = dados.descricao || "Sem descrição.";
            document.getElementById(prefix + '-price-modal').innerText = "Valor: " + formatarNum(dados.preco) + " Ryos";
            const img = document.getElementById(prefix + '-img-modal');
            img.src = dados.imagem || IMG_PADRAO;
            img.onerror = () => img.src = IMG_PADRAO;
            
            if(tipo === 'jutsu') document.getElementById(prefix + '-rank-modal').innerText = "Rank " + dados.rank;
            if(tipo === 'tool') document.getElementById(prefix + '-rank-modal').innerText = dados.dano || "Ferramenta";
            if(tipo === 'item') document.getElementById(prefix + '-rank-modal').innerText = dados.efeito || "Item";
            
            document.getElementById(tipo + 'Modal').style.display = 'flex';
        }

        window.verDetalhesJutsu = (id, dados) => abrirModal('jutsu', dados);
        window.verDetalhesFerramenta = (id, dados) => abrirModal('tool', dados);
        window.verDetalhesItem = (id, dados) => abrirModal('item', dados);
        
        window.fecharJutsuModal = () => document.getElementById('jutsuModal').style.display = 'none';
        window.fecharToolModal = () => document.getElementById('toolModal').style.display = 'none';
        window.fecharItemModal = () => document.getElementById('itemModal').style.display = 'none';

        // --- FEED POST ---
        window.handleImageUpload = async (e) => { if(e.target.files[0]) { try { currentImageBase64 = await comprimirImagem(e.target.files[0]); document.getElementById('preview-image').src = currentImageBase64; document.getElementById('preview-container').style.display='block'; } catch(e){alert("Erro imagem");} } };
        window.removeImage = () => { document.getElementById('imageInput').value=''; currentImageBase64=null; document.getElementById('preview-container').style.display='none'; };
        
        window.publicarPost = async () => {
            const txt = document.getElementById('postInput').value;
            if(!txt.trim() && !currentImageBase64) return alert("Escreva algo!");
            const btn = document.querySelector('.btn-post'); btn.innerText="..."; btn.disabled=true;
            try {
                const autor = currentUserData.apelido || currentUserData.nome || "Ninja";
                await addDoc(collection(db, "posts"), {
                    uid: auth.currentUser.uid, autor: autor, autorAvatar: currentUserData.avatar,
                    conteudo: txt, imagem: currentImageBase64, data: serverTimestamp(), likes: [], savedBy: [], comments: []
                });
                document.getElementById('postInput').value=''; removeImage();
            } catch(e) { alert("Erro ao postar."); } finally { btn.innerText="Publicar"; btn.disabled=false; }
        };

        window.renderFeed = (filter) => {
            const c = document.getElementById('feed-container'); if(!c) return;
            onSnapshot(query(collection(db, "posts"), orderBy("data", "desc")), (snap) => {
                c.innerHTML = ''; if(snap.empty) { c.innerHTML = '<p style="text-align:center; padding:20px;">Nenhuma publicação.</p>'; return; }
                snap.forEach(d => {
                    const p = d.data(); const id = d.id;
                    if(filter === 'saved' && !p.savedBy.includes(auth.currentUser.uid)) return;
                    
                    const isOwner = p.uid === auth.currentUser.uid;
                    const menuHTML = isOwner ? `
                        <div class="post-menu-container">
                            <div class="post-options-btn" onclick="this.nextElementSibling.classList.toggle('active')">...</div>
                            <div class="post-dropdown">
                                <div class="dropdown-item danger" onclick="deletarPost('${id}')">Excluir</div>
                            </div>
                        </div>` : '';
                        
                    const div = document.createElement('div'); div.className = 'post';
                    div.innerHTML = `
                        <div class="post-header">
                            <div class="user-avatar-post"><img src="${p.autorAvatar || IMG_PADRAO}"></div>
                            <div class="post-info"><span class="post-author">${p.autor}</span><span class="post-time">Agora</span></div>
                            ${menuHTML}
                        </div>
                        <div class="post-content">${p.conteudo}</div>
                        ${p.imagem ? `<img src="${p.imagem}" class="post-image" onclick="verPost('${id}')">` : ''}
                        <div class="post-actions">
                            <button class="action-btn ${p.likes.includes(auth.currentUser.uid)?'liked':''}" onclick="toggleLike('${id}')"><i class="${p.likes.includes(auth.currentUser.uid)?'fa-solid':'fa-regular'} fa-heart"></i> ${p.likes.length}</button>
                            <button class="action-btn" onclick="verPost('${id}')"><i class="fa-regular fa-comment"></i> ${p.comments.length}</button>
                            <button class="action-btn ${p.savedBy.includes(auth.currentUser.uid)?'saved':''}" onclick="toggleSave('${id}')" style="margin-left:auto;"><i class="${p.savedBy.includes(auth.currentUser.uid)?'fa-solid':'fa-regular'} fa-bookmark"></i></button>
                        </div>
                    `;
                    c.appendChild(div);
                });
            });
        };
        
        window.deletarPost = async (id) => { if(confirm("Apagar?")) await deleteDoc(doc(db, "posts", id)); };
        window.toggleLike = async (id) => { const ref=doc(db,"posts",id); const s=await getDoc(ref); const l=s.data().likes||[]; if(l.includes(auth.currentUser.uid)) await updateDoc(ref,{likes:arrayRemove(auth.currentUser.uid)}); else await updateDoc(ref,{likes:arrayUnion(auth.currentUser.uid)}); };
        window.toggleSave = async (id) => { const ref=doc(db,"posts",id); const s=await getDoc(ref); const l=s.data().savedBy||[]; if(l.includes(auth.currentUser.uid)) await updateDoc(ref,{savedBy:arrayRemove(auth.currentUser.uid)}); else await updateDoc(ref,{savedBy:arrayUnion(auth.currentUser.uid)}); };
        
        window.verPost = async (id) => {
            currentOpenPostId = id;
            const s = await getDoc(doc(db, "posts", id));
            const p = s.data();
            document.getElementById('modalPostContent').innerHTML = p.imagem ? `<img src="${p.imagem}" style="width:100%; height:100%; object-fit:contain;">` : `<div style="padding:20px;">${p.conteudo}</div>`;
            renderComentarios(p.comments);
            document.getElementById('commentModal').style.display = 'flex';
        };
        function renderComentarios(l) { document.getElementById('commentsList').innerHTML = l.map(c => `<div><b>${c.autor}</b>: ${c.texto}</div>`).join(''); }
        window.submitComment = async () => { const t = document.getElementById('newCommentText').value; if(!t) return; await updateDoc(doc(db, "posts", currentOpenPostId), { comments: arrayUnion({ autor: currentUserData.nome, texto: t }) }); document.getElementById('newCommentText').value = ""; verPost(currentOpenPostId); };
        window.closeModal = () => document.getElementById('commentModal').style.display = 'none';

        // --- PERSONAGENS, MISSÕES & OUTROS (RESTAURADOS E BLINDADOS) ---
        async function carregarPersonagens() {
            const c = document.getElementById('directory-grid'); c.innerHTML = 'Carregando...';
            try {
                const s = await getDocs(collection(db, "users"));
                c.innerHTML = '';
                if(s.empty) { c.innerHTML = '<p>Nenhum ninja.</p>'; return; }
                s.forEach(d => {
                    const u = d.data();
                    const k = document.createElement('div'); k.className = 'card';
                    k.onclick = () => window.verPerfil(d.id);
                    k.innerHTML = `<div style="width:60px; height:60px; border-radius:50%; overflow:hidden; margin:0 auto 10px;"><img src="${u.avatar || IMG_PADRAO}" style="width:100%; height:100%; object-fit:cover;"></div><h4>${u.nome}</h4><p>${u.apelido||"Desconhecido"}</p>`;
                    c.appendChild(k);
                });
            } catch(e) { c.innerHTML = 'Erro ao carregar.'; }
        }

        window.verPerfil = async (uid) => {
            const s = await getDoc(doc(db, "users", uid));
            if(s.exists()) {
                const u = s.data();
                document.getElementById('profile-modal-name').innerText = u.nome || "Ninja";
                document.getElementById('profile-modal-char').innerText = u.apelido || "";
                document.getElementById('profile-modal-img').src = u.avatar || IMG_PADRAO;
                const set = (id, v) => document.getElementById(id).innerText = v;
                set('prof-nivel', u.nivel || 1); set('prof-cargo', u.cargo || "Genin"); set('prof-ryos', formatarNum(u.ryos));
                set('prof-jutsus', u.meusJutsus?.length||0); set('prof-tools', u.ferramentas?.length||0); set('prof-items', u.itens?.length||0);
                set('prof-wins', u.vitorias||0); set('prof-loses', u.derrotas||0); set('prof-draws', u.empates||0);
                document.getElementById('profileModal').style.display = 'flex';
            }
        }
        window.fecharProfileModal = () => document.getElementById('profileModal').style.display = 'none';
        
        async function carregarMissoes() { 
            const c = document.getElementById('missoes-grid'); 
            const map = currentUserData.statusMissoes || {}; 
            try {
                const s = await getDocs(collection(db, "missoes")); 
                c.innerHTML = ''; 
                if(s.empty) { c.innerHTML = '<p>Sem missões.</p>'; return; }
                s.forEach((d) => { 
                    const m = d.data(); const id = d.id; const st = map[id] || 'neutro'; 
                    const k = document.createElement('div'); k.className = 'card'; 
                    let statusText="Disponível", statusColor="#777"; 
                    if(st==='em_andamento'){statusText="Em Andamento";statusColor="orange";}
                    else if(st==='aprovado'){statusText="Coletar!";statusColor="green";}
                    else if(st==='concluido'){statusText="Concluída";statusColor="blue";} 
                    k.onclick = () => verDetalhesMissao(id, st); 
                    k.innerHTML=`<h4>${m.titulo}</h4><p style="font-size:0.9rem; color:${statusColor}; font-weight:bold;">${statusText}</p>`; 
                    c.appendChild(k); 
                }); 
            } catch(e) { c.innerHTML = 'Erro.'; }
        }
        
        window.verDetalhesMissao = async (id, status) => { 
            const docRef = doc(db, "missoes", id); 
            const docSnap = await getDoc(docRef); 
            if(docSnap.exists()){ 
                const m = docSnap.data(); 
                document.getElementById('missao-name-modal').innerText = m.titulo; 
                document.getElementById('missao-desc-modal').innerText = m.descricao; 
                document.getElementById('missao-reward-modal').innerText = formatarNum(m.recompensa); 
                document.getElementById('missao-img-modal').src = m.imagem || IMG_PADRAO; 
                const actionDiv = document.getElementById('missao-actions-modal'); 
                actionDiv.innerHTML = ''; 
                if(status === 'neutro') { actionDiv.innerHTML = `<button class="mission-btn-start" onclick="iniciarMissao('${id}')">Aceitar Missão</button>`; } 
                else if(status === 'em_andamento') { actionDiv.innerHTML = `<button class="mission-btn-wait">Aguardando Aprovação...</button>`; } 
                else if(status === 'aprovado') { actionDiv.innerHTML = `<button class="mission-btn-collect" onclick="coletarRecompensa('${id}', ${m.recompensa})">Receber Recompensa</button>`; } 
                else if(status === 'concluido') { actionDiv.innerHTML = `<button class="mission-btn-done">Missão Concluída</button>`; } 
                document.getElementById('missaoModal').style.display = 'flex'; 
            } 
        };
        window.fecharMissaoModal = () => { document.getElementById('missaoModal').style.display = 'none'; };

        // RANKINGS
        window.carregarRankings = async () => { 
            const c = document.getElementById('ranking-container'); if(!c) return; 
            try {
                const s = await getDocs(collection(db, "users")); 
                let l = []; s.forEach(d=>l.push(d.data())); 
                c.innerHTML = ''; 
                renderRank(c,"Ryos",l,'ryos'); renderRank(c,"Vitórias",l,'vitorias'); 
            } catch(e) { c.innerHTML = 'Erro.'; }
        };
        function renderRank(c,t,l,f) { const s=[...l].sort((a,b)=>(b[f]||0)-(a[f]||0)).slice(0,5); let h=`<div class="ranking-col"><h3>${t}</h3><table class="ranking-table">`; s.forEach((u,i)=>h+=`<tr><td>${i+1}. ${u.nome}</td><td>${formatarNum(u[f])}</td></tr>`); h+='</table></div>'; c.innerHTML+=h; }

        window.iniciarMissao = async (id) => { await updateDoc(doc(db, "users", auth.currentUser.uid), { [`statusMissoes.${id}`]: 'em_andamento' }); alert("Iniciada!"); location.reload(); };
        window.coletarRecompensa = async (id, val) => { await updateDoc(doc(db, "users", auth.currentUser.uid), { ryos: increment(val), [`statusMissoes.${id}`]: 'concluido' }); alert(`Recebido ${val} Ryos!`); location.reload(); };

        function editarHistoria() { const n=prompt("História:",currentUserData.historiaTexto||""); if(n){ const i=prompt("Imagem URL:",currentUserData.historiaImagem||""); updateDoc(doc(db,"users",auth.currentUser.uid),{historiaTexto:n,historiaImagem:i}).then(()=>location.reload()); } }
        
        async function carregarFrases() { 
            const c = document.getElementById('frases-list-container'); if(!c) return;
            onSnapshot(query(collection(db, "frases"), orderBy("data", "desc")), (snap) => {
                c.innerHTML = ''; if(snap.empty) { c.innerHTML = '<p style="text-align:center; color:#777;">Nenhuma frase.</p>'; return; }
                snap.forEach(d => { 
                    const f = d.data(); 
                    const div = document.createElement('div'); 
                    div.className = 'frase-item'; 
                    div.onclick = () => copiarFrase(f.texto); 
                    div.innerHTML = `<div class="frase-content">"${f.texto}"</div><div class="frase-author">- ${f.autor || "Desconhecido"}</div>`; 
                    c.appendChild(div); 
                });
            });
        }
        async function adicionarFrase() { const t=document.getElementById('novaFraseInput').value; if(t){ await addDoc(collection(db,"frases"),{texto:t,autor:currentUserData.nome,data:serverTimestamp()}); document.getElementById('novaFraseInput').value=''; } }
        window.copiarFrase = (texto) => { navigator.clipboard.writeText(texto).then(() => { const f = document.getElementById('copyFeedback'); f.style.display = 'block'; setTimeout(() => { f.style.display = 'none'; }, 2000); }); };

        // ADMIN
        async function carregarPainelAdmin() {
            const c = document.getElementById('admin-missoes-grid'); if(!c) return;
            c.innerHTML = 'Carregando pendências...';
            const s = await getDocs(collection(db, "users"));
            c.innerHTML = '';
            let found = false;
            s.forEach(u => {
                const d = u.data();
                const m = d.statusMissoes || {};
                for (const [mid, st] of Object.entries(m)) {
                    if(st === 'em_andamento') {
                        found = true;
                        const k = document.createElement('div'); k.className = 'card';
                        k.innerHTML = `<h4>${d.nome}</h4><p>Missão ID: ${mid}</p><button class="mission-btn-collect" onclick="aprovarMissao('${u.id}','${mid}')">Aprovar</button>`;
                        c.appendChild(k);
                    }
                }
            });
            if(!found) c.innerHTML = '<p>Nenhuma missão pendente.</p>';
        }
        window.aprovarMissao = async (uid, mid) => { if(confirm("Aprovar?")) { await updateDoc(doc(db, "users", uid), { [`statusMissoes.${mid}`]: 'aprovado' }); alert("Aprovado!"); location.reload(); } };

    </script>
</body>
</html>
